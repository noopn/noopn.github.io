<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <meta charset="utf-8" />
       
      <meta name="keywords" content="前端 web react" />
       
      <meta name="description" content="前端技术与生活。" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 四月八日</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">
 
<link rel="stylesheet" href="/css/fonts/remixicon.css">
 
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="/js/pace.min.js"></script>
       
 

      <link rel="stylesheet" href="/css/bulma.min.css" />
      <script src="/js/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <script src="/js/mermaid.min.js"></script>
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <!-- hexo injector head_end start -->
<link rel="stylesheet" href="/css/katex.min.css">

<link rel="stylesheet" href="/css/style.css">
<!-- hexo injector head_end end --></head>
  </html>
</html>


<body>
  <div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover1.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">四月八日</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="/js/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['愿你足够强大，也要足够温柔', '最轻的并不是一根羽毛，而是一双飞鸟的翅膀', ''],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="posts-other/hdSky自动点赞"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/999fc3e99003/"
    >Puppeteer + 火山 OCR 实现自动登录和爬虫操作</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/999fc3e99003/" class="article-date">
  <time datetime="2025-03-01T03:12:00.000Z" itemprop="datePublished">2025-03-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="火山-OCR-Api-接入"><a href="#火山-OCR-Api-接入" class="headerlink" title="火山 OCR Api 接入"></a>火山 OCR Api 接入</h4><p>需要在用户中心获取 AK,SK 密钥</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// request.js</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&quot;crypto&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> util = <span class="built_in">require</span>(<span class="string">&quot;util&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> url = <span class="built_in">require</span>(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> qs = <span class="built_in">require</span>(<span class="string">&quot;querystring&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不参与加签过程的 header key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">HEADER_KEYS_TO_IGNORE</span> = <span class="keyword">new</span> <span class="title class_">Set</span>([</span><br><span class="line">  <span class="string">&quot;authorization&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content-type&quot;</span>,</span><br><span class="line">  <span class="string">&quot;content-length&quot;</span>,</span><br><span class="line">  <span class="string">&quot;user-agent&quot;</span>,</span><br><span class="line">  <span class="string">&quot;presigned-expires&quot;</span>,</span><br><span class="line">  <span class="string">&quot;expect&quot;</span>,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// do request example</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">request</span>(<span class="params">signParams</span>) &#123;</span><br><span class="line">  signParams.<span class="property">headers</span> = &#123;</span><br><span class="line">    ...signParams.<span class="property">headers</span>,</span><br><span class="line">    [<span class="string">&quot;X-Date&quot;</span>]: <span class="title function_">getDateTimeNow</span>(),</span><br><span class="line">  &#125;;</span><br><span class="line">  signParams.<span class="property">bodySha</span> = <span class="title function_">getBodySha</span>(signParams.<span class="property">body</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 正规化 query object， 防止串化后出现 query 值为 undefined 情况</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> [key, val] <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">entries</span>(signParams.<span class="property">query</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (val === <span class="literal">undefined</span> || val === <span class="literal">null</span>) &#123;</span><br><span class="line">      signParams.<span class="property">query</span>[key] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> authorization = <span class="title function_">sign</span>(signParams);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">fetch</span>(</span><br><span class="line">    <span class="string">`https://iam.volcengineapi.com/?<span class="subst">$&#123;qs.stringify(signParams.query)&#125;</span>`</span>,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">headers</span>: &#123;</span><br><span class="line">        ...signParams.<span class="property">headers</span>,</span><br><span class="line">        <span class="title class_">Authorization</span>: authorization,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">method</span>: signParams.<span class="property">method</span>,</span><br><span class="line">      <span class="attr">body</span>: signParams.<span class="property">body</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sign</span>(<span class="params">params</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    headers = &#123;&#125;,</span><br><span class="line">    query = &#123;&#125;,</span><br><span class="line">    region = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    serviceName = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    method = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    pathName = <span class="string">&quot;/&quot;</span>,</span><br><span class="line">    accessKeyId = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    secretAccessKey = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    needSignHeaderKeys = [],</span><br><span class="line">    bodySha,</span><br><span class="line">  &#125; = params;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> datetime = headers[<span class="string">&quot;X-Date&quot;</span>];</span><br><span class="line">  <span class="keyword">const</span> date = datetime.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">8</span>); <span class="comment">// YYYYMMDD</span></span><br><span class="line">  <span class="comment">// 创建正规化请求</span></span><br><span class="line">  <span class="keyword">const</span> [signedHeaders, canonicalHeaders] = <span class="title function_">getSignHeaders</span>(</span><br><span class="line">    headers,</span><br><span class="line">    needSignHeaderKeys</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> canonicalRequest = [</span><br><span class="line">    method.<span class="title function_">toUpperCase</span>(),</span><br><span class="line">    pathName,</span><br><span class="line">    <span class="title function_">queryParamsToString</span>(query) || <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;canonicalHeaders&#125;</span>\n`</span>,</span><br><span class="line">    signedHeaders,</span><br><span class="line">    bodySha || <span class="title function_">hash</span>(<span class="string">&quot;&quot;</span>),</span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> credentialScope = [date, region, serviceName, <span class="string">&quot;request&quot;</span>].<span class="title function_">join</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="comment">// 创建签名字符串</span></span><br><span class="line">  <span class="keyword">const</span> stringToSign = [</span><br><span class="line">    <span class="string">&quot;HMAC-SHA256&quot;</span>,</span><br><span class="line">    datetime,</span><br><span class="line">    credentialScope,</span><br><span class="line">    <span class="title function_">hash</span>(canonicalRequest),</span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="comment">// 计算签名</span></span><br><span class="line">  <span class="keyword">const</span> kDate = <span class="title function_">hmac</span>(secretAccessKey, date);</span><br><span class="line">  <span class="keyword">const</span> kRegion = <span class="title function_">hmac</span>(kDate, region);</span><br><span class="line">  <span class="keyword">const</span> kService = <span class="title function_">hmac</span>(kRegion, serviceName);</span><br><span class="line">  <span class="keyword">const</span> kSigning = <span class="title function_">hmac</span>(kService, <span class="string">&quot;request&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> signature = <span class="title function_">hmac</span>(kSigning, stringToSign).<span class="title function_">toString</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    <span class="string">&quot;HMAC-SHA256&quot;</span>,</span><br><span class="line">    <span class="string">`Credential=<span class="subst">$&#123;accessKeyId&#125;</span>/<span class="subst">$&#123;credentialScope&#125;</span>,`</span>,</span><br><span class="line">    <span class="string">`SignedHeaders=<span class="subst">$&#123;signedHeaders&#125;</span>,`</span>,</span><br><span class="line">    <span class="string">`Signature=<span class="subst">$&#123;signature&#125;</span>`</span>,</span><br><span class="line">  ].<span class="title function_">join</span>(<span class="string">&quot; &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hmac</span>(<span class="params">secret, s</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHmac</span>(<span class="string">&quot;sha256&quot;</span>, secret).<span class="title function_">update</span>(s, <span class="string">&quot;utf8&quot;</span>).<span class="title function_">digest</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">hash</span>(<span class="params">s</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> crypto.<span class="title function_">createHash</span>(<span class="string">&quot;sha256&quot;</span>).<span class="title function_">update</span>(s, <span class="string">&quot;utf8&quot;</span>).<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">queryParamsToString</span>(<span class="params">params</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(params)</span><br><span class="line">    .<span class="title function_">sort</span>()</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> val = params[key];</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> val === <span class="string">&quot;undefined&quot;</span> || val === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> escapedKey = <span class="title function_">uriEscape</span>(key);</span><br><span class="line">      <span class="keyword">if</span> (!escapedKey) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(val)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;escapedKey&#125;</span>=<span class="subst">$&#123;val</span></span></span><br><span class="line"><span class="subst"><span class="string">          .map(uriEscape)</span></span></span><br><span class="line"><span class="subst"><span class="string">          .sort()</span></span></span><br><span class="line"><span class="subst"><span class="string">          .join(<span class="string">`&amp;<span class="subst">$&#123;escapedKey&#125;</span>=`</span>)&#125;</span>`</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;escapedKey&#125;</span>=<span class="subst">$&#123;uriEscape(val)&#125;</span>`</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">    .<span class="title function_">filter</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> v)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;&amp;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getSignHeaders</span>(<span class="params">originHeaders, needSignHeaders</span>) &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">trimHeaderValue</span>(<span class="params">header</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> header.<span class="property">toString</span>?.().<span class="title function_">trim</span>().<span class="title function_">replace</span>(<span class="regexp">/\s+/g</span>, <span class="string">&quot; &quot;</span>) ?? <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> h = <span class="title class_">Object</span>.<span class="title function_">keys</span>(originHeaders);</span><br><span class="line">  <span class="comment">// 根据 needSignHeaders 过滤</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(needSignHeaders)) &#123;</span><br><span class="line">    <span class="keyword">const</span> needSignSet = <span class="keyword">new</span> <span class="title class_">Set</span>(</span><br><span class="line">      [...needSignHeaders, <span class="string">&quot;x-date&quot;</span>, <span class="string">&quot;host&quot;</span>].<span class="title function_">map</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="title function_">toLowerCase</span>())</span><br><span class="line">    );</span><br><span class="line">    h = h.<span class="title function_">filter</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> needSignSet.<span class="title function_">has</span>(k.<span class="title function_">toLowerCase</span>()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 根据 ignore headers 过滤</span></span><br><span class="line">  h = h.<span class="title function_">filter</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> !<span class="variable constant_">HEADER_KEYS_TO_IGNORE</span>.<span class="title function_">has</span>(k.<span class="title function_">toLowerCase</span>()));</span><br><span class="line">  <span class="keyword">const</span> signedHeaderKeys = h</span><br><span class="line">    .<span class="title function_">slice</span>()</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> k.<span class="title function_">toLowerCase</span>())</span><br><span class="line">    .<span class="title function_">sort</span>()</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;;&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> canonicalHeaders = h</span><br><span class="line">    .<span class="title function_">sort</span>(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (a.<span class="title function_">toLowerCase</span>() &lt; b.<span class="title function_">toLowerCase</span>() ? -<span class="number">1</span> : <span class="number">1</span>))</span><br><span class="line">    .<span class="title function_">map</span>(<span class="function">(<span class="params">k</span>) =&gt;</span> <span class="string">`<span class="subst">$&#123;k.toLowerCase()&#125;</span>:<span class="subst">$&#123;trimHeaderValue(originHeaders[k])&#125;</span>`</span>)</span><br><span class="line">    .<span class="title function_">join</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> [signedHeaderKeys, canonicalHeaders];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">uriEscape</span>(<span class="params">str</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">encodeURIComponent</span>(str)</span><br><span class="line">      .<span class="title function_">replace</span>(<span class="regexp">/[^A-Za-z0-9_.~\-%]+/g</span>, <span class="built_in">escape</span>)</span><br><span class="line">      .<span class="title function_">replace</span>(</span><br><span class="line">        <span class="regexp">/[*]/g</span>,</span><br><span class="line">        <span class="function">(<span class="params">ch</span>) =&gt;</span> <span class="string">`%<span class="subst">$&#123;ch.charCodeAt(<span class="number">0</span>).toString(<span class="number">16</span>).toUpperCase()&#125;</span>`</span></span><br><span class="line">      );</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getDateTimeNow</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">  <span class="keyword">return</span> now.<span class="title function_">toISOString</span>().<span class="title function_">replace</span>(<span class="regexp">/[:-]|\.\d&#123;3&#125;/g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 body sha256</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getBodySha</span>(<span class="params">body</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> hash = crypto.<span class="title function_">createHash</span>(<span class="string">&quot;sha256&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> body === <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">    hash.<span class="title function_">update</span>(body);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (body <span class="keyword">instanceof</span> url.<span class="property">URLSearchParams</span>) &#123;</span><br><span class="line">    hash.<span class="title function_">update</span>(body.<span class="title function_">toString</span>());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (util.<span class="title function_">isBuffer</span>(body)) &#123;</span><br><span class="line">    hash.<span class="title function_">update</span>(body);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> hash.<span class="title function_">digest</span>(<span class="string">&quot;hex&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = request;</span><br></pre></td></tr></table></figure>

<h4 id="puppeteer-爬虫"><a href="#puppeteer-爬虫" class="headerlink" title="puppeteer 爬虫"></a>puppeteer 爬虫</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> puppeteer = <span class="built_in">require</span>(<span class="string">&quot;puppeteer&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">&quot;./request&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// const &#123; createWorker &#125; = require(&quot;tesseract.js&quot;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const worker = await createWorker(&quot;eng&quot;);</span></span><br><span class="line"><span class="comment">// const ret = await worker.recognize(fs.readFileSync(&quot;./authCode.jpg&quot;));</span></span><br><span class="line"><span class="comment">// console.log(ret.data.text);</span></span><br><span class="line"></span><br><span class="line">(<span class="title function_">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.<span class="title function_">launch</span>(&#123;</span><br><span class="line">    <span class="attr">headless</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">defaultViewport</span>: &#123; <span class="attr">width</span>: <span class="number">1400</span>, <span class="attr">height</span>: <span class="number">900</span> &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">const</span> page = <span class="keyword">await</span> browser.<span class="title function_">newPage</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置导航的默认超时时间为永不超时</span></span><br><span class="line">  page.<span class="title function_">setDefaultNavigationTimeout</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果添加请求拦截器，需要添加下面一句代码</span></span><br><span class="line">  <span class="comment">// 如果使用响应拦截器，则不需要添加，添加会导致代码不向下执行</span></span><br><span class="line">  <span class="comment">//  await page.setRequestInterception(true);</span></span><br><span class="line"></span><br><span class="line">  page.<span class="title function_">on</span>(<span class="string">&quot;response&quot;</span>, <span class="title function_">async</span> (response) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> url = response.<span class="title function_">url</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拦截验证码图片，保存到本地</span></span><br><span class="line">    <span class="keyword">if</span> (url.<span class="title function_">includes</span>(<span class="string">&quot;image.php&quot;</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> img = <span class="keyword">await</span> response.<span class="title function_">buffer</span>();</span><br><span class="line">      fs.<span class="title function_">writeFileSync</span>(<span class="string">`./authCode.jpg`</span>, img);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    page.<span class="title function_">waitForNavigation</span>(),</span><br><span class="line">    page.<span class="title function_">goto</span>(<span class="string">&quot;https://hdsky.me/login.php&quot;</span>),</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&quot;input[name=&#x27;username&#x27;]&quot;</span>, <span class="string">&quot;username&quot;</span>);</span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&quot;input[name=&#x27;password&#x27;]&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 调用 OCR api 识别验证码</span></span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">AccessKeyId</span> = <span class="string">&quot;___YOUR_ACCESS_KEY___&quot;</span>;</span><br><span class="line">  <span class="keyword">const</span> <span class="title class_">SecretKey</span> = <span class="string">&quot;___YOUR_SECRET_KEY___&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> img = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;./authCode.jpg&quot;</span>);</span><br><span class="line">  <span class="keyword">const</span> imgBase64 = img.<span class="title function_">toString</span>(<span class="string">&quot;base64&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> body = <span class="keyword">new</span> <span class="title class_">URLSearchParams</span>();</span><br><span class="line">  body.<span class="title function_">append</span>(<span class="string">&quot;image_base64&quot;</span>, imgBase64);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    <span class="attr">data</span>: &#123;</span><br><span class="line">      <span class="attr">line_texts</span>: [authCode],</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125; = <span class="keyword">await</span> <span class="title function_">request</span>(&#123;</span><br><span class="line">    <span class="attr">headers</span>: &#123;</span><br><span class="line">      <span class="comment">// 火山文档提示必传，但是 sdk 会过滤掉</span></span><br><span class="line">      <span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">method</span>: <span class="string">&quot;POST&quot;</span>,</span><br><span class="line">    <span class="comment">// api 文档必填参数</span></span><br><span class="line">    <span class="attr">query</span>: &#123;</span><br><span class="line">      <span class="title class_">Action</span>: <span class="string">&quot;OCRNormal&quot;</span>,</span><br><span class="line">      <span class="title class_">Version</span>: <span class="string">&quot;2020-08-26&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">accessKeyId</span>: <span class="title class_">AccessKeyId</span>,</span><br><span class="line">    <span class="attr">secretAccessKey</span>: <span class="title class_">SecretKey</span>,</span><br><span class="line">    <span class="attr">serviceName</span>: <span class="string">&quot;cv&quot;</span>,</span><br><span class="line">    <span class="attr">region</span>: <span class="string">&quot;cn-north-1&quot;</span>,</span><br><span class="line">    body,</span><br><span class="line">  &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>) =&gt;</span> res.<span class="title function_">json</span>());</span><br><span class="line"></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(authCode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> page.<span class="title function_">type</span>(<span class="string">&quot;input[name=&#x27;imagestring&#x27;]&quot;</span>, authCode);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 点击事件导致页面导航，需要等待导航结束</span></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    page.<span class="title function_">waitForNavigation</span>(),</span><br><span class="line">    page.<span class="title function_">click</span>(<span class="string">&quot;input[type=&#x27;submit&#x27;]&quot;</span>),</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">    page.<span class="title function_">waitForNavigation</span>(),</span><br><span class="line">    page.<span class="title function_">click</span>(<span class="string">&quot;a[href=&#x27;torrents.php&#x27;]&quot;</span>),</span><br><span class="line">  ]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">loop</span> = <span class="keyword">async</span> (<span class="params">startPage</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> list = <span class="keyword">await</span> page.$$(<span class="string">&quot;table tr[class*=progresstr]&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = list[i];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 监听新页面创建事件，并获取详情页的 page 对象</span></span><br><span class="line">      <span class="keyword">const</span> detailPromise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">        browser.<span class="title function_">once</span>(<span class="string">&quot;targetcreated&quot;</span>, <span class="title function_">async</span> (target) =&gt; &#123;</span><br><span class="line">          <span class="keyword">if</span> (target.<span class="title function_">type</span>() === <span class="string">&quot;page&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newPage = <span class="keyword">await</span> target.<span class="title function_">page</span>();</span><br><span class="line">            <span class="title function_">resolve</span>(newPage);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> a = <span class="keyword">await</span> item.$(</span><br><span class="line">        <span class="string">&quot;td:nth-child(2) table &gt; tbody &gt; tr &gt; td:nth-child(1) &gt; a&quot;</span></span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">await</span> a.<span class="title function_">click</span>();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> detailPage = <span class="keyword">await</span> detailPromise;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> detailPage.<span class="title function_">waitForSelector</span>(<span class="string">&quot;#saythanks&quot;</span>, &#123;</span><br><span class="line">        <span class="attr">timeout</span>: <span class="number">0</span>,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> detailPage.<span class="title function_">click</span>(<span class="string">&quot;#saythanks&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`第 <span class="subst">$&#123;startPage&#125;</span> 页，第 <span class="subst">$&#123;i + <span class="number">1</span>&#125;</span> 条已点赞`</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">4000</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> detailPage.<span class="title function_">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">loop2</span> = <span class="keyword">async</span> (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> startPage = fs.<span class="title function_">readFileSync</span>(<span class="string">&quot;./skypage.txt&quot;</span>, <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> search = <span class="keyword">await</span> page.$(<span class="string">&quot;input[type=number]:nth-child(2)&quot;</span>);</span><br><span class="line">    <span class="keyword">await</span> search.<span class="title function_">click</span>(&#123; <span class="attr">clickCount</span>: <span class="number">3</span> &#125;);</span><br><span class="line">    <span class="keyword">await</span> search.<span class="title function_">type</span>(startPage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title class_">Promise</span>.<span class="title function_">all</span>([</span><br><span class="line">      page.<span class="title function_">waitForNavigation</span>(),</span><br><span class="line">      page.<span class="title function_">click</span>(<span class="string">&quot;input[type=submit]:nth-child(3)&quot;</span>),</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">loop</span>(startPage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startPage &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      fs.<span class="title function_">writeFileSync</span>(<span class="string">&quot;./skypage.txt&quot;</span>, (startPage - <span class="number">1</span>).<span class="title function_">toString</span>(), <span class="string">&quot;utf8&quot;</span>);</span><br><span class="line">      <span class="title function_">loop2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">loop2</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// await browser.close();</span></span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h4 id="debian-执行任务报错"><a href="#debian-执行任务报错" class="headerlink" title="debian 执行任务报错"></a>debian 执行任务报错</h4><p>Failed to launch the browser process: error while loading shared libraries: libnss3.so: cannot open shared object file</p>
<p>可能是没想相关的执行环境安装以下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install libpangocairo-1.0-0 libx11-xcb1 libxcomposite1 libxcursor1 libxdamage1 libxi6 libxtst6 libnss3 libcups2 libxss1 libxrandr2 libasound2 libatk1.0-0 libgtk-3-0</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> apt-get install -y libgbm-dev</span><br></pre></td></tr></table></figure>

 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Puppeteer/" rel="tag">Puppeteer</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/dify私有化部署"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/280eafda3a35/"
    >Dify 工作流</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/280eafda3a35/" class="article-date">
  <time datetime="2025-02-05T04:17:00.000Z" itemprop="datePublished">2025-02-05</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="下载-Dify-源码"><a href="#下载-Dify-源码" class="headerlink" title="下载 Dify 源码"></a>下载 Dify 源码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/langgenius/dify.git</span><br></pre></td></tr></table></figure>

<h4 id="启动-Dify"><a href="#启动-Dify" class="headerlink" title="启动 Dify"></a>启动 Dify</h4><p>进入 Dify 源代码的 docker 目录，执行一键启动命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> dify/docker</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>

<p>如果您的系统安装了 Docker Compose V2 而不是 V1，请使用 docker compose 而不是 docker-compose。通过$ docker compose version 检查版本号：Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+] Running 7/7</span><br><span class="line">✔ Container docker-web-1 Started 1.0s</span><br><span class="line">✔ Container docker-redis-1 Started 1.1s</span><br><span class="line">✔ Container docker-weaviate-1 Started 0.9s</span><br><span class="line">✔ Container docker-db-1 Started 0.0s</span><br><span class="line">✔ Container docker-worker-1 Started 0.7s</span><br><span class="line">✔ Container docker-api-1 Started 0.8s</span><br><span class="line">✔ Container docker-nginx-1 Started</span><br></pre></td></tr></table></figure>

<p>检查容器是否正常运行,包括 3 个业务服务 api &#x2F; worker &#x2F; web，以及 4 个基础组件 weaviate &#x2F; db &#x2F; redis &#x2F; nginx，都要处于启动状态。注意下面每一个服务的 status 都要是 Up 状态才算真正启动成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker compose ps</span><br><span class="line"></span><br><span class="line">NAME IMAGE COMMAND SERVICE CREATED STATUS PORTS</span><br><span class="line">docker-api-1 langgenius/dify-api:0.3.2 <span class="string">&quot;/entrypoint.sh&quot;</span> api 4 seconds ago Up 2 seconds 80/tcp, 5001/tcp</span><br><span class="line">docker-db-1 postgres:15-alpine <span class="string">&quot;docker-entrypoint.s…&quot;</span> db 4 seconds ago Up 2 seconds 0.0.0.0:5432-&gt;5432/tcp</span><br><span class="line">docker-nginx-1 nginx:latest <span class="string">&quot;/docker-entrypoint.…&quot;</span> nginx 4 seconds ago Up 2 seconds 0.0.0.0:80-&gt;80/tcp</span><br><span class="line">docker-redis-1 redis:6-alpine <span class="string">&quot;docker-entrypoint.s…&quot;</span> redis 4 seconds ago Up 3 seconds 6379/tcp</span><br><span class="line">docker-weaviate-1 semitechnologies/weaviate:1.18.4 <span class="string">&quot;/bin/weaviate --hos…&quot;</span> weaviate 4 seconds ago Up 3 seconds</span><br><span class="line">docker-web-1 langgenius/dify-web:0.3.2 <span class="string">&quot;/entrypoint.sh&quot;</span> web 4 seconds ago Up 3 seconds 80/tcp, 3000/tcp</span><br><span class="line">docker-worker-1 langgenius/dify-api:0.3.2 <span class="string">&quot;/entrypoint.sh&quot;</span> worker 4 seconds ago Up 2 seconds 80/tcp, 5001/tcp</span><br></pre></td></tr></table></figure>

<h4 id="升级-Dify"><a href="#升级-Dify" class="headerlink" title="升级 Dify"></a>升级 Dify</h4><p>进入 Dify 源代码的 docker 目录，按顺序执行以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> dify/docker</span><br><span class="line">git pull origin main</span><br><span class="line">docker compose down</span><br><span class="line">docker compose pull</span><br><span class="line">docker compose up -d</span><br></pre></td></tr></table></figure>

<h4 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h4><ul>
<li>首页正常显示，当点击设置管理员用户页面一直在加载中，浏览器控制台报错,</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/console/api/setup 502</span><br></pre></td></tr></table></figure>

<p>检查服务的状态 status 栏并是不是 Up 状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker compose ps</span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs docker-api-1</span><br></pre></td></tr></table></figure>

<p><img src="/posts/280eafda3a35/001.png"></p>
<p>这是由于 Docker 运行权限不够，需要被赋予更高的权限。</p>
<p>在 docker-compose.yaml 文件中，给 services 下每一个 service 最后一行都加上 privileged: true,然后重新启动 Dify 即可。</p>
<ul>
<li>由于在第一个问题中，Ubuntu 系统中，本地修改了 docker-compose.yaml 文件，在使用 git pull origin main 会提示本地有文件没有提交：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">error: Your <span class="built_in">local</span> changes to the following files would be overwritten by merge:</span><br><span class="line">docker/docker-compose.yaml</span><br><span class="line">Please, commit your changes or stash them before you can merge.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要提交修改</span></span><br><span class="line">git config --global user.email <span class="string">&quot;xxx&quot;</span></span><br><span class="line">git config --global user.name <span class="string">&quot;xxx&quot;</span></span><br><span class="line"></span><br><span class="line">git add docker-compose.yaml</span><br><span class="line">git commit -m <span class="string">&quot;local change&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Docker 无法拉取镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// daemon.json可能会不存在，直接 vi /etc/docker/daemon.json可以创建</span><br><span class="line"><span class="built_in">sudo</span> vi /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;新的镜像源地址&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart  docker //重启docker</span><br><span class="line"></span><br><span class="line">docker info //查看镜像源有没有配置成功</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/AI/" rel="tag">AI</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Dify/" rel="tag">Dify</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-react/react-router-v7"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/ce9fece0e470/"
    >React Router v7 概览</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/ce9fece0e470/" class="article-date">
  <time datetime="2025-01-23T12:26:46.000Z" itemprop="datePublished">2025-01-23</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/React/">React</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>v7 可以让 React Router 作为框架来使用，利用提供的 cli 工具创建项目，提供了相关的构建包，以 React Router 的视角开发项目。以下是官方提供的特性说明：</p>
<ul>
<li>Vite 捆绑器和开发服务器集成</li>
<li>热模块替换</li>
<li>代码分割</li>
<li>带类型安全的路由约定</li>
<li>文件系统或基于配置的路由</li>
<li>带类型安全的数据加载</li>
<li>带类型安全的操作</li>
<li>操作后页面数据的自动重新验证</li>
<li>SSR、SPA 和静态呈现策略</li>
<li>待定状态和乐观 UI 的 api</li>
<li>部署适配器</li>
</ul>
<h4 id="特殊文件"><a href="#特殊文件" class="headerlink" title="特殊文件"></a>特殊文件</h4><h5 id="react-router-config-ts"><a href="#react-router-config-ts" class="headerlink" title="react-router.config.ts"></a>react-router.config.ts</h5><p>可选，<a target="_blank" rel="noopener" href="https://api.reactrouter.com/v7/types/_react_router_dev.config.Config.html">全局的配置文件</a>。</p>
<h5 id="root-ts"><a href="#root-ts" class="headerlink" title="root.ts"></a>root.ts</h5><p>必须，唯一的必须路由，是 routes 目录有所有路由的父路由，也用于描述 HTML 文档。</p>
<p>可以把 React Router 提供的全局组件写在这里，只会渲染一次。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">LinksFunction</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Links</span>, <span class="title class_">Meta</span>, <span class="title class_">Outlet</span>, <span class="title class_">Scripts</span>, <span class="title class_">ScrollRestoration</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./global-styles.css&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charSet</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        &#123;/* 所有路由上的所有meta导出都会在这里渲染 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Meta</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        &#123;/* 所有路由上的所有link导出都会在这里渲染 */&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Links</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        &#123;/* 子路由*/&#125;</span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        &#123;/* 管理客户端渲染时候的滚动条位置 */&#125;</span></span><br><span class="line"><span class="language-xml">        &#123;/* If you use a nonce-based content security policy for scripts, you must provide the `nonce` prop. Otherwise, omit the nonce prop as shown here. */&#125;</span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ScrollRestoration</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Scripts</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Content Security Policy (CSP)<br>CSP 是一种浏览器安全机制，用于防止跨站脚本攻击（XSS）等安全问题。通过配置 CSP，开发者可以限制页面加载的资源（如脚本、样式等）的来源和执行方式。</p>
<p>Nonce<br>nonce 是 CSP 中的一个概念，表示一个随机生成的字符串（一次性值）。通过在 CSP 中配置 nonce，可以允许特定的内联脚本或动态加载的脚本执行，而不会违反 CSP 规则。</p>
<p>如果你使用了基于 nonce 的 CSP 策略：<br>如果你的 CSP 配置中使用了 nonce 来允许脚本执行，那么你需要在 React Router 的相关组件中传递 nonce 属性。这是因为 React Router 可能会动态加载或执行一些脚本，这些脚本需要符合你的 CSP 策略。</p>
<p>如果你没有使用基于 nonce 的 CSP 策略：<br>如果你的 CSP 配置不涉及 nonce，或者你不需要对脚本进行特殊限制，那么你可以忽略 nonce 属性（如示例中所示）.</p>
<p>假设你的 CSP 配置如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src <span class="string">&#x27;nonce-abc123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这意味着只有带有 nonce&#x3D;”abc123” 的脚本才能执行。在这种情况下，你需要在 React Router 中传递 nonce 属性：</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Router</span> nonce=<span class="string">&quot;abc123&quot;</span>&gt;&#123;<span class="comment">/* Your routes here */</span>&#125;&lt;/<span class="title class_">Router</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>layout-export</strong></p>
<p>一个单独导出的组件，可以避免在 Root Component,HydrateFallback, ErrorBoundary 重复声明 app 的框架元素。</p>
<h5 id="routes-ts"><a href="#routes-ts" class="headerlink" title="routes.ts"></a>routes.ts</h5><p>必须， 统一的路由配置文件，它将自动对每个路由进行代码拆分，为参数和数据提供类型安全，并在用户导航到数据时自动加载具有挂起状态访问权的数据。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; route &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="title function_">route</span>(<span class="string">&quot;contacts/:contactId&quot;</span>, <span class="string">&quot;routes/contact.tsx&quot;</span>),</span><br><span class="line">] <span class="keyword">satisfies</span> <span class="title class_">RouteConfig</span>;</span><br></pre></td></tr></table></figure>

<h5 id="index-route"><a href="#index-route" class="headerlink" title="index route"></a>index route</h5><p>当路由没有匹配任何路径的时候，他会在 Outlet 中显示空白，index 可以当做是默认路由的视图。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/routes.ts</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; index, route &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="title function_">index</span>(<span class="string">&quot;routes/home.tsx&quot;</span>),</span><br><span class="line">  <span class="title function_">route</span>(<span class="string">&quot;contacts/:contactId&quot;</span>, <span class="string">&quot;routes/contact.tsx&quot;</span>),</span><br><span class="line">] <span class="keyword">satisfies</span> <span class="title class_">RouteConfig</span>;</span><br></pre></td></tr></table></figure>

<h5 id="layout-route"><a href="#layout-route" class="headerlink" title="layout route"></a>layout route</h5><p>可以在路由的配置文件中，描述组件的嵌套关系.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">RouteConfig</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; index, layout, route &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/routes&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="title function_">layout</span>(<span class="string">&quot;layouts/sidebar.tsx&quot;</span>, [</span><br><span class="line">    <span class="title function_">index</span>(<span class="string">&quot;routes/home.tsx&quot;</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 会渲染到 layouts/sidebar.tsx 这个 layout 下的 Outlet 里面。</span></span><br><span class="line">    <span class="title function_">route</span>(<span class="string">&quot;contacts/:contactId&quot;</span>, <span class="string">&quot;routes/contact.tsx&quot;</span>),</span><br><span class="line">  ]),</span><br><span class="line">  <span class="title function_">route</span>(<span class="string">&quot;about&quot;</span>, <span class="string">&quot;routes/about.tsx&quot;</span>),</span><br><span class="line">] <span class="keyword">satisfies</span> <span class="title class_">RouteConfig</span>;</span><br></pre></td></tr></table></figure>

<h4 id="特殊组件"><a href="#特殊组件" class="headerlink" title="特殊组件"></a>特殊组件</h4><h5 id=""><a href="#" class="headerlink" title=""></a><Outlet /></h5><p>用于展示路由</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/root.tx</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Outlet</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;detail&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">Outlet</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h4><h5 id="clientLoader"><a href="#clientLoader" class="headerlink" title="clientLoader"></a>clientLoader</h5><p>只在浏览器中调用，为路由组件提供数据</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/root.tsx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">clientLoader</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> contacts = <span class="keyword">await</span> <span class="title function_">getContacts</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123; contacts &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">&#123; loaderData &#125;: <span class="built_in">any</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; contacts &#125; = loaderData;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="HydrateFallback"><a href="#HydrateFallback" class="headerlink" title="HydrateFallback"></a>HydrateFallback</h5><p>如果通过 react-router.config.ts 配置为客户端渲染，那么在 app 根文件执行之前是没有任何内容。</p>
<p>提供一个 HydrateFallback 方法，在 app 被渲染前提供能内容。他会被直接添加到 index.html 文件中。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/root.tsx</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">HydrateFallback</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;loading-splash&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading, please wait...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="URL-Params-Loader"><a href="#URL-Params-Loader" class="headerlink" title="URL Params Loader"></a>URL Params Loader</h5><p>在 loader 方法中获取</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// existing imports</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Route</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./+types/contact&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">loader</span>(<span class="params">&#123; params &#125;: <span class="title class_">Route</span>.<span class="title class_">LoaderArgs</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> contact = <span class="keyword">await</span> <span class="title function_">getContact</span>(params.<span class="property">contactId</span>);</span><br><span class="line">  <span class="keyword">return</span> &#123; contact &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">Contact</span>(<span class="params">&#123; loaderData &#125;: <span class="title class_">Route</span>.<span class="title class_">ComponentProps</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; contact &#125; = loaderData;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// existing code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在组件中获取</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">SidebarLayout</span>(<span class="params">&#123; params &#125;: <span class="title class_">Route</span>.<span class="title class_">ComponentProps</span></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(params);</span><br><span class="line">  <span class="keyword">return</span>; <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="useNavigation"><a href="#useNavigation" class="headerlink" title="useNavigation"></a>useNavigation</h5><p>返回当前导航信息，包括导航状态。 导航需要等到 loader 结束时才会渲染页面，因此可以使用导航状态展示 loading 信息。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useNavigation &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">SidebarLayout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> navigation = <span class="title function_">useNavigation</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">id</span>=<span class="string">&quot;detail&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">className</span>=<span class="string">&#123;navigation.state</span> === <span class="string">&quot;loading&quot;</span> ? &quot;<span class="attr">loading</span>&quot; <span class="attr">:</span> &quot;&quot;&#125;</span></span></span><br><span class="line"><span class="tag"><span class="language-xml">    &gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="类型安全"><a href="#类型安全" class="headerlink" title="类型安全"></a>类型安全</h4><p>React Router 自动为每个路由生成类型文件存放在 <code>+types/&lt;route file&gt;.d.ts</code>.</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/root.tsx</span></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Route</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./+types/root&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">App</span>(<span class="params">&#123; loaderData &#125;: <span class="title class_">Route</span>.<span class="title class_">ComponentProps</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; contacts &#125; = loaderData;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="预渲染静态路由"><a href="#预渲染静态路由" class="headerlink" title="预渲染静态路由"></a>预渲染静态路由</h4><p>对于没有内容的页面，希望在加载的时候不展示 loading,而是直接展示内容。</p>
<p>指定哪些页面需要预渲染，他们会在打包阶段，打包为静态文件。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//react-router.config.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="keyword">type</span> <span class="title class_">Config</span> &#125; <span class="keyword">from</span> <span class="string">&quot;@react-router/dev/config&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  <span class="attr">ssr</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">prerender</span>: [<span class="string">&quot;/about&quot;</span>],</span><br><span class="line">&#125; <span class="keyword">satisfies</span> <span class="title class_">Config</span>;</span><br></pre></td></tr></table></figure>

<h4 id="抛出错误"><a href="#抛出错误" class="headerlink" title="抛出错误"></a>抛出错误</h4><p>在 loader 中抛出错误, 会被 root.tsx 的 ErrorBoundary 捕获</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">clientLoader</span>(<span class="params">&#123; params &#125;: <span class="title class_">Route</span>.<span class="title class_">LoaderArgs</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> contact = <span class="keyword">await</span> <span class="title function_">getContact</span>(params.<span class="property">contactId</span>);</span><br><span class="line">  <span class="keyword">if</span> (!contact) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Response</span>(<span class="string">&quot;Not Found&quot;</span>, &#123; <span class="attr">status</span>: <span class="number">404</span> &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; contact &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="表单提交"><a href="#表单提交" class="headerlink" title="表单提交"></a>表单提交</h4><p>默认情况下，表单的提交会触发 history 的修改，因此使用 Form 组件，它会就近拦截表单的提交，并将请求通过 fetch 发送到最近的 action 中处理。</p>
<p>Form 组件上的 action 会作为请求提交的地址，用于匹配路由。</p>
<p>action 的规则是如果路由匹配那么对应的路由文件中必须存在 action 处理函数否则报错，如果没有对应的路由文件(例如写在 layout 文件中)，会使用 root 中的 action 处理。</p>
<p>需要注意的是使用 action 不能将 react-router.config.ts 中的 ssr 设置为 false,因为这是服务端的功能。</p>
<p>clientLoader 也需要修改为 loader 从服务端获取数据。</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// root.tsx</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果在路由上没有其他的文件写 action 就会到root的action中处理</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">action</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> contact = <span class="keyword">await</span> <span class="title function_">createEmptyContact</span>();</span><br><span class="line">  <span class="keyword">return</span> &#123; contact &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Form</span> &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">function</span> <span class="title function_">SidebarLayout</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>New<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Form</span>&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除信息</p>
<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前文件 app/routes/contact.tsx 对应的路由是 contacts/:contactId</span></span><br><span class="line"><span class="comment">// 因此表但会提交到 contacts/:contactId/destroy</span></span><br><span class="line"><span class="comment">// 需要为此路由创建对应的文件</span></span><br><span class="line"></span><br><span class="line">&lt;<span class="title class_">Form</span></span><br><span class="line">  action=<span class="string">&quot;destroy&quot;</span></span><br><span class="line">  method=<span class="string">&quot;post&quot;</span></span><br><span class="line">  onSubmit=&#123;<span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> response = <span class="title function_">confirm</span>(<span class="string">&quot;Please confirm you want to delete this record.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!response) &#123;</span><br><span class="line">      event.<span class="title function_">preventDefault</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;&#125;</span><br><span class="line">&gt;</span><br><span class="line">  <span class="language-xml"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line">&lt;/<span class="title class_">Form</span>&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/routes/destroy-contact.tsx</span></span><br><span class="line"><span class="keyword">import</span> &#123; redirect &#125; <span class="keyword">from</span> <span class="string">&quot;react-router&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">type</span> &#123; <span class="title class_">Route</span> &#125; <span class="keyword">from</span> <span class="string">&quot;./+types/destroy-contact&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; deleteContact &#125; <span class="keyword">from</span> <span class="string">&quot;../data&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">action</span>(<span class="params">&#123; params &#125;: <span class="title class_">Route</span>.<span class="title class_">ActionArgs</span></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="title function_">deleteContact</span>(params.<span class="property">contactId</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">redirect</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/routes.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  <span class="title function_">route</span>(<span class="string">&quot;contacts/:contactId/destroy&quot;</span>, <span class="string">&quot;routes/destroy-contact.tsx&quot;</span>),</span><br><span class="line">] <span class="keyword">satisfies</span> <span class="title class_">RouteConfig</span>;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/" rel="tag">React</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/TrueNas应用配置"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/9aadbf0e844b/"
    >TrueNas 应用配置</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/9aadbf0e844b/" class="article-date">
  <time datetime="2025-01-19T02:31:33.000Z" itemprop="datePublished">2025-01-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="MinIO"><a href="#MinIO" class="headerlink" title="MinIO"></a>MinIO</h4><p>参考<a target="_blank" rel="noopener" href="https://www.truenas.com/docs/truenasapps/stableapps/minioapp/">安装文档</a>, 挂载点配置需要开启 ACL, 文件默认保存 export 目录下。</p>
<p>Nginx 配置参考<a target="_blank" rel="noopener" href="https://min.io/docs/minio/linux/integrations/setup-nginx-proxy-with-minio.html">MinIO 配置文档</a>, 需要添加<code>chunked_transfer_encoding off;</code></p>
<h4 id="NextCloud"><a href="#NextCloud" class="headerlink" title="NextCloud"></a>NextCloud</h4><ul>
<li><p>dataSet 创建<br>父文件夹需要有以下权限 <code>user:www-data</code>,<code>group:www-data</code>,<code>user:netdata</code>,<code>group:docker</code>,<code>user:root</code>,<code>group:root</code>,<code>user:apps</code><br>user 文件夹需要有以下权限 <code>user:www-data</code>,<code>group:www-data</code>,<code>user:apps</code><br>data 文件夹需要有以下权限 <code>user:www-data</code>,<code>group:www-data</code>,<code>user:apps</code><br>db 文件夹需要有以下权限 <code>user:netdata</code>,<code>group:docker</code>,<code>user:root</code>,<code>group:root</code>,<code>user:apps</code></p>
</li>
<li><p>APT Packages 需要添加 <code>ffmpeg</code> <code>smbclient</code></p>
</li>
<li><p>host 需要填写真实访问的域名</p>
</li>
<li><p>Database Password 注意不要有 <code>#@?&amp;</code> 等特殊符号</p>
</li>
<li><p>Certificate ID 选择默认证书，避免 nextCloud 提示警告，如果前端有 nginx 代理，需要使用 https</p>
</li>
<li><p>在 config&#x2F;config.php 中添加 <a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/30/admin_manual/configuration_server/background_jobs_configuration.html#parameters">maintenance_window_start</a> 消除调度任务的警告</p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://docs.nextcloud.com/server/stable/admin_manual/installation/nginx.html">nginx配置</a></p>
</li>
</ul>
<h4 id="虚拟机配置"><a href="#虚拟机配置" class="headerlink" title="虚拟机配置"></a>虚拟机配置</h4><p><strong>Nas 服务器开机虚拟化功能</strong>,配置以下字段,其余字段可以保持默认</p>
<p>Boot Method ： UEFI</p>
<p>CPU Mode : Host Passthrough</p>
<p>Select Disk Type : VirtIO<br>virtIO 是一个优化的虚拟磁盘驱动程序，专为虚拟化环境设计，提供更高的性能和较低的开销。它支持更高的数据传输速率，特别适用于 I&#x2F;O 密集型的应用场景。</p>
<p>Adapter Type：VirtIO</p>
<p><strong>如果安装后提示 CD-ROM 加载错误，可以删除 CD-ROM 设备后重试</strong></p>
<h4 id="Jellyfin"><a href="#Jellyfin" class="headerlink" title="Jellyfin"></a>Jellyfin</h4><p>nginx 代理按照<a target="_blank" rel="noopener" href="https://jellyfin.org/docs/general/networking/nginx/">官方文档</a>操作</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TrueNas/" rel="tag">TrueNas</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-javascript/babel-source"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/c106a03ba7c5/"
    >Babel 源码与插件</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/c106a03ba7c5/" class="article-date">
  <time datetime="2024-12-22T07:12:00.000Z" itemprop="datePublished">2024-12-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/JavaScript/">JavaScript</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="调式源码"><a href="#调式源码" class="headerlink" title="调式源码"></a>调式源码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/&lt;your-github-username&gt;/babel</span><br><span class="line"><span class="built_in">cd</span> babel</span><br><span class="line">make bootstrap</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在想要调试文件的入口处添加断点</span></span><br><span class="line"><span class="comment"># -i 指定测试package</span></span><br><span class="line"><span class="comment"># -t 指定测试用例 fixtures</span></span><br><span class="line">yarn run  jest -i packages/babel-parser -t <span class="string">&#x27;es2016/simple parameter list/arrow function&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="插件开发最小化环境"><a href="#插件开发最小化环境" class="headerlink" title="插件开发最小化环境"></a>插件开发最小化环境</h4><p>相关依赖包</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;babel-plugin-tester&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^11.0.4&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;jest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^29.7.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ts-jest&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^29.2.6&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ts-node&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^10.9.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typescript&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.8.2&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>测试文件入口与 fixtures 用例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//__test__/index.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; pluginTester &#125; <span class="keyword">from</span> <span class="string">&quot;babel-plugin-tester&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> insertLogPlugin <span class="keyword">from</span> <span class="string">&quot;../plugins/babel-plugin-insert-log&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> path <span class="keyword">from</span> <span class="string">&quot;path&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_">pluginTester</span>(&#123;</span><br><span class="line">  <span class="attr">plugin</span>: insertLogPlugin,</span><br><span class="line"></span><br><span class="line">  <span class="attr">babelOptions</span>: &#123;</span><br><span class="line">    <span class="attr">plugins</span>: [<span class="string">&quot;@babel/plugin-syntax-jsx&quot;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">fixtures</span>: path.<span class="title function_">join</span>(__dirname, <span class="string">&quot;fixtures&quot;</span>),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// __tests__/fixtures/in-arrow-function/code.ts</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = (<span class="params"></span>) =&gt; <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// __tests__/fixtures/in-arrow-function/output.ts</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">a</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="number">1</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>jest 配置文件, 排除 fixtures 目录下的测试用例，避免多次执行</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">import(&#x27;ts-jest&#x27;).JestConfigWithTsJest</span>&#125; **/</span></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">testEnvironment</span>: <span class="string">&quot;node&quot;</span>,</span><br><span class="line">  <span class="attr">transform</span>: &#123;</span><br><span class="line">    <span class="string">&quot;^.+.tsx?$&quot;</span>: [<span class="string">&quot;ts-jest&quot;</span>, &#123;&#125;],</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">testMatch</span>: [<span class="string">&quot;**/__tests__/**/*&quot;</span>, <span class="string">&quot;!**/fixtures/**/*&quot;</span>],</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="babel-parser"><a href="#babel-parser" class="headerlink" title="babel-parser"></a>babel-parser</h4><p>使用多个类继承，完善 parser 功能</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Parser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">StatementParser</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">StatementParser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">ExpressionParser</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">ExpressionParser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">LValParser</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">LValParser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">NodeUtils</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">NodeUtils</span> <span class="keyword">extends</span> <span class="title class_ inherited__">UtilParser</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">UtilParser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Tokenizer</span>&#123;&#125;</span><br><span class="line">abstract <span class="keyword">class</span> <span class="title class_">Tokenizer</span> <span class="keyword">extends</span> <span class="title class_ inherited__">CommentsParser</span>&#123;&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CommentsParser</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BaseParser</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>解析 <code>le\\u0074 x = 5</code> 流程：</p>
<ul>
<li><p>实例化 Parser，调用 parse 方法开始解析</p>
</li>
<li><p>初始化 file, grogram 节点</p>
</li>
<li><p>尝试解析 token</p>
<ul>
<li><p>跳过空白符，注释等</p>
</li>
<li><p>根据第一个字符判断要如何解析， 比如 <code>l</code> 为一个小写字母， 会被当作 Identifier 解析</p>
</li>
<li><p>尝试读取完成的标识符</p>
<p><code>this.state.pos += str &lt;= 0xffff ? 1 : 2;</code> 如果字符 charCode 大于 0xffff 例如 <code>龘</code>, 则向后移动两个字符</p>
<p>如果匹配到 <code>\</code>, 则判断是否是一个 Unicode 转义序列,后面三位必须是 <code>\\u</code> 开头，如果不是则标记错误</p>
<p>如果是一个转移字符，尝试读取这个转义字符并返回, 因此第一个 token 会是 <code>let</code></p>
</li>
<li><p>解析 Program 节点，<code>let</code> 作为 ExpressionStatement 加入 Program 节点，保存在 body 数组中</p>
<p>继续尝试解析 x &#x3D; 5 这个表达式作为 AssignmentExpression，x 和 5 作为 Identifier 和 NumericLiteral 加入 AssignmentExpression 分别作为 left 和 right</p>
</li>
</ul>
</li>
</ul>
<p>最终形成的树结构就是 ast.</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Babel/" rel="tag">Babel</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/OpenWrt"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/0d8a7ae7bced/"
    >OpenWrt 安装与设置</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/0d8a7ae7bced/" class="article-date">
  <time datetime="2024-11-04T05:59:26.000Z" itemprop="datePublished">2024-11-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="下载固件"><a href="#下载固件" class="headerlink" title="下载固件"></a>下载固件</h4><p><a target="_blank" rel="noopener" href="https://openwrt.org/">OpenWrt</a> 官方版本，所有的第三方版本都是基于官方的自定义编译，<br><a target="_blank" rel="noopener" href="https://downloads.immortalwrt.org/">immortalwrt</a> 是针对国内用户编译的第三方版本，推荐优先使用。<a target="_blank" rel="noopener" href="https://github.com/immortalwrt/immortalwrt">[GitHub]</a></p>
<p>点击 All Downloads</p>
<p><img src="/posts/0d8a7ae7bced/001.png"></p>
<p>选择适配的 x86 版本</p>
<blockquote>
<p>SquashFS 和 Ext4 是两种不同的文件系统，各自有不同的特点和应用场景：</p>
<ul>
<li>SquashFS 只读的文件系统，经过压缩后可以节省存储空间。默认情况下不支持直接写入，因此需要将可写数据放在单独的 Overlay 文件系统上。</li>
<li>Ext4 一种常用的可读写文件系统，支持动态修改。</li>
</ul>
</blockquote>
<p><img src="/posts/0d8a7ae7bced/002.png"></p>
<p>由于 OpenWrt 并不会将所有硬盘剩余空间作为根路径，因此不同的文件格式对应不同的磁盘组成，在安装后需要对根分区扩容。</p>
<ul>
<li>Ext4: <code>/boot</code> + <code>/</code>根分区(读写) + 剩余未分区磁盘</li>
<li>SquashFS： <code>/boot</code> + <code>/rom</code>(只读) + <code>/</code>根分区(读写) + 剩余未分区磁盘 (优先选择此版本，方便迁移和系统恢复)</li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>参考<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/installation/openwrt_x86#installation">官方安装文档</a>，采用写入镜像文件方式，由于 OpenWrt 没有提供安装引导，所以需要用 <a target="_blank" rel="noopener" href="https://www.wepe.com.cn/">微 PE</a> 或 老毛桃[<a target="_blank" rel="noopener" href="https://www.laomaotao.net/]">https://www.laomaotao.net/]</a> 等工具制作一个 WinPE 启动盘, 将用到的固件，和固件写入工具保存到启动盘中，当进入 WinPE 系统后是用写入工具写入镜像。</p>
<blockquote>
<p>Windows Preinstallation Environment（Windows PE），Windows 预安装环境，是带有有限服务的最小 Win32 子系统，基于以完整 Windows 环境或者保护模式运行的 Windows 3.x 及以上内核。这类系统一般很小。它包括了运行 Windows 安装程序及脚本、连接网络共享、自动化基本过程以及执行硬件验证所需的最小功能。</p>
</blockquote>
<p>另外需要下载一个镜像写入工具 <a target="_blank" rel="noopener" href="https://win32diskimager.org/">Win32 Disk Imager</a> 或 <a target="_blank" rel="noopener" href="https://etcher.balena.io/">balenaEtcher</a></p>
<p>将镜像写入工具, 解压出的 OpenWrt 镜像(.iso)文件, 复制到制作好的 WinPE 启动 U 盘中。</p>
<p><img src="/posts/0d8a7ae7bced/003.png"></p>
<p>将 U 盘插入到软路由中(软路由需要接上鼠标，键盘，显示器)，开机时入到软路由的 BIOS，将默认的固态硬盘启动改为 U 盘启动。</p>
<p><img src="/posts/0d8a7ae7bced/004.png"></p>
<p>保存重启后，进入 WinPE 系统，首先使用 WinPE 自带的 DiskGenius 工具，删除软路由硬盘的所有分区并保存。打开写入工具，选择磁盘和镜像并写入。</p>
<p><img src="/posts/0d8a7ae7bced/005.png"></p>
<p>写入成功后，重启系统再次进入 BIOS,将 U 盘启动修改回硬盘启动，保存并再次重启。</p>
<p>启动成功后，会看见有命令行信息，如果卡住不动，尝试按一下回车键，这样会进入 OpenWrt 系统。</p>
<p>首次登录提示修改密码，执行 <code>passwd</code> 命令，修改 root 账户密码，此密码也是网页登录的密码。</p>
<p><img src="/posts/0d8a7ae7bced/006.png"></p>
<p>修改网络配置信息，执行命令 <code>vi /etc/config/network</code>,</p>
<p>将 config device 的 list_ports 修改为 eth1<br>将 interface lan 的 option ipaddr 修改为内网不会冲突的 IP 地址例如 <code>192.168.100.1</code> 或 <code>10.10.0.1</code><br>将 interface wan 和 interface wan6 的 option device 修改为 eth0</p>
<blockquote>
<p>wan 口表示外网，也就是网络运营商的网线，通常更习惯将第一个网口作为插入外网网线，后面插入的都是内网设备，这样更有条理性</p>
</blockquote>
<p><img src="/posts/0d8a7ae7bced/007.png"></p>
<p>保存后重启设备,访问前需要重新连接一下设备：</p>
<ul>
<li>软路由插入电源并开机</li>
<li>运营商光猫的网线，链接到软路由的 eth0 网口。</li>
<li>wifi 路由器需要在管理后台，设置为 AP 有线中继模式，用一个网线将软路由的 eth1 网口，链接到路由器的第一个网口。</li>
<li>其他内网设备可以通过网线连接软路由或路由器，也可以直接通过 wifi 网络链接.</li>
</ul>
<p>这是虽然不能上网，单已经可以通过内网中其他设备访问 <code>/etc/config/network</code> 中设置的 lan 口的 ipaddr 访问到 OpenWrt 的 UI 界面。</p>
<h4 id="pve-虚拟机安装"><a href="#pve-虚拟机安装" class="headerlink" title="pve 虚拟机安装"></a>pve 虚拟机安装</h4><p>上传镜像文件到 pve， 创建虚拟机， 删除虚拟机的默认磁盘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qm importdisk [虚拟机ID] [镜像路径] [磁盘]</span><br><span class="line"></span><br><span class="line">qm importdisk 4444 /var/lib/vz/template/iso/immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img storage</span><br></pre></td></tr></table></figure>

<p>虚拟机 &#x3D;&gt; 硬件 添加未启用的磁盘<br>虚拟机 &#x3D;&gt; 选线 修改刚刚添加的磁盘为第一启动项</p>
<h4 id="wan-口配置"><a href="#wan-口配置" class="headerlink" title="wan 口配置"></a>wan 口配置</h4><p>最先的配置一定是软路由可以上网，输入账号密码进入到软路由的 UI 界面，点击菜单 <strong>网络</strong> &#x3D;&gt; <strong>接口</strong> 点击 wan 口的编辑按钮，协议切换为 PPPoE ，输入账号密码，即可上网。</p>
<blockquote>
<p>此方式是通过 PPPoE 拨号上网，需要致电运营商，将网络改为桥接模式，并提供账号密码。</p>
</blockquote>
<p><img src="/posts/0d8a7ae7bced/008.png"></p>
<h4 id="lan-口配置"><a href="#lan-口配置" class="headerlink" title="lan 口配置"></a>lan 口配置</h4><p>网络 &#x3D;&gt; 接口 &#x3D;&gt; 设备 选择 br_lan, 在网桥端口中将其他的端口都添加到 br_lan 这个网桥中，方便让局域网中的设备互相访问</p>
<h4 id="磁盘扩容"><a href="#磁盘扩容" class="headerlink" title="磁盘扩容"></a>磁盘扩容</h4><p>在菜单 <strong>状态</strong> &#x3D;&gt; <strong>概览</strong> 中可以看到，磁盘空间只有几百 M, 这是因为 OpenWrt 默认不会将剩余空间作为根节点。</p>
<p>官方 openwrt 参考 <a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/installation/openwrt_x86#expanding_root_partition">官方的扩容操作</a></p>
<p>immortalwrt 在安装前可以使用以下命令修改镜像的分区大小</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将镜像文件扩容</span></span><br><span class="line"><span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero bs=1M count=98304 &gt;&gt; immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用parted扩容文件系统</span></span><br><span class="line"></span><br><span class="line">parted immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img</span><br><span class="line">GNU Parted 3.5</span><br><span class="line">Using /var/lib/vz/template/iso/immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img</span><br><span class="line">Welcome to GNU Parted! Type <span class="string">&#x27;help&#x27;</span> to view a list of commands.</span><br><span class="line">(parted) p</span><br><span class="line">Error: The backup GPT table is corrupt, but the primary appears OK, so that will be used.</span><br><span class="line">OK/Cancel? OK</span><br><span class="line">Warning: Not all of the space available to</span><br><span class="line">/var/lib/vz/template/iso/immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img appears to be used, you can fix the GPT</span><br><span class="line">to use all of the space (an extra 30 blocks) or <span class="built_in">continue</span> with the current setting?</span><br><span class="line">Fix/Ignore? Fix</span><br><span class="line">Model:  (file)</span><br><span class="line">Disk /var/lib/vz/template/iso/immortalwrt-24.10.3-x86-64-generic-squashfs-combined-efi__1_.img: 348MB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name  Flags</span><br><span class="line">128     17.4kB  262kB   245kB                      bios_grub</span><br><span class="line"> 1      262kB   33.8MB  33.6MB  fat16              legacy_boot</span><br><span class="line"> 2      33.8MB  348MB   315MB</span><br><span class="line"></span><br><span class="line">(parted) resizepart 2 100%</span><br><span class="line">(parted) q</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>immortalwrt 也可以安装后扩容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line"></span><br><span class="line">opkg install fdisk lsblk losetup f2fs-toolsopkg install lsblk fdisk resize2fs losetup blkid f2fs-tools tree</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘信息</span></span><br><span class="line"><span class="comment"># df -h</span></span><br><span class="line"><span class="comment"># fdisk -l</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 替换为自己的磁盘</span></span><br><span class="line">fdisk /dev/sda</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看磁盘</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): p</span><br><span class="line"></span><br><span class="line">Device         Boot  Start    End Sectors  Size Id Type</span><br><span class="line">/dev/sda1            65536  98303   32768   16M 83 Linux</span><br><span class="line">/dev/sda2            131072 745471  614400  300M 83 Linux</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): d</span><br><span class="line">Partition number (1,2, default 2): 2</span><br><span class="line"></span><br><span class="line">Partition 2 has been deleted.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 新建磁盘 需要注意 sector 起始位置一定要与原有磁盘信息中 start 大小相同</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): n</span><br><span class="line">Partition <span class="built_in">type</span></span><br><span class="line">   p   primary (1 primary, 0 extended, 3 free)</span><br><span class="line">   e   extended (container <span class="keyword">for</span> logical partitions)</span><br><span class="line">Select (default p): p</span><br><span class="line">Partition number (2-4, default 2): 2</span><br><span class="line">First sector (2048-31268863, default 2048): 131072</span><br><span class="line">Last sector, +/-sectors or +/-size&#123;K,M,G,T,P&#125; (131072-31268863, default 31268863):</span><br><span class="line"></span><br><span class="line">Created a new partition 2 of <span class="built_in">type</span> <span class="string">&#x27;Linux&#x27;</span> and of size 14.8 GiB.</span><br><span class="line">Partition <span class="comment">#2 contains a squashfs signature.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一定要选 n ，不要修改标识符</span></span><br><span class="line">Do you want to remove the signature? [Y]es/[N]o: n</span><br><span class="line"></span><br><span class="line"><span class="comment"># 保存</span></span><br><span class="line">Command (m <span class="keyword">for</span> <span class="built_in">help</span>): w</span><br><span class="line">The partition table has been altered.</span><br></pre></td></tr></table></figure>

<p>对文件系统扩容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">losetup</span><br><span class="line"><span class="comment"># 记录 offset 的值</span></span><br><span class="line"><span class="comment"># NAME       SIZELIMIT  OFFSET AUTOCLEAR RO BACK-FILE  DIO LOG-SEC</span></span><br><span class="line"><span class="comment"># /dev/loop0         0 6291456         1  0 /mmcblk0p2   0     512</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用相同的 offset 创建一个临时的 循环设备</span></span><br><span class="line">losetup -f -o 6291456 /dev/sda2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂在这个设备以便于记录日志， 如果不挂在会导致不能访问</span></span><br><span class="line">mount /dev/loop1 /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载设备后可以执行扩容</span></span><br><span class="line">umount /dev/loop1</span><br><span class="line"></span><br><span class="line">resize.f2fs /dev/loop1</span><br></pre></td></tr></table></figure>

<p>修改分区大小后会导致磁盘 UUID 改变，需要更新</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">blkid</span><br><span class="line"><span class="comment"># /dev/loop0: LABEL=&quot;rootfs_data&quot; UUID=&quot;b32ce334-3193-428b-9ae3-2a156379ecc8&quot; BLOCK_SIZE=&quot;4096&quot; TYPE=&quot;f2fs&quot;</span></span><br><span class="line"><span class="comment"># 记录 sda2 的新的 PARTUUID</span></span><br><span class="line"><span class="comment"># /dev/sda2: BLOCK_SIZE=&quot;262144&quot; TYPE=&quot;squashfs&quot; PARTUUID=&quot;ff2d03b0-3d06-4001-bb97-367a0265a03f&quot;</span></span><br><span class="line"></span><br><span class="line">vi /boot/grub/grub.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改对应的 PARTUUID 为最新值</span></span><br><span class="line"><span class="comment"># menuentry &quot;ImmortalWrt&quot; &#123;</span></span><br><span class="line"><span class="comment">#         linux /boot/vmlinuz root=PARTUUID=484c7fc2-ae74-a97d-23da-c3b75cf79602 rootwait  console=tty1 console=ttyS0,115200n8 noinit</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># menuentry &quot;ImmortalWrt (failsafe)&quot; &#123;</span></span><br><span class="line"><span class="comment">#         linux /boot/vmlinuz failsafe=true root=PARTUUID=484c7fc2-ae74-a97d-23da-c3b75cf79602 rootwait  console=tty1 console=ttyS0,1</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用以下脚本更新</span></span><br><span class="line">ROOT_BLK=<span class="string">&quot;<span class="subst">$(readlink -f /sys/dev/block/<span class="string">&quot;<span class="subst">$(awk -e \</span></span></span></span></span><br><span class="line"><span class="subst"><span class="string"><span class="subst"><span class="string">&#x27;$9==<span class="string">&quot;/dev/root&quot;</span>&#123;print $3&#125;&#x27; /proc/self/mountinfo)</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">ROOT_DISK=<span class="string">&quot;/dev/<span class="subst">$(basename <span class="string">&quot;<span class="variable">$&#123;ROOT_BLK%/*&#125;</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">ROOT_DEV=<span class="string">&quot;/dev/<span class="variable">$&#123;ROOT_BLK##*/&#125;</span>&quot;</span></span><br><span class="line">ROOT_UUID=<span class="string">&quot;<span class="subst">$(partx -g -o UUID <span class="string">&quot;<span class="variable">$&#123;ROOT_DEV&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;ROOT_DISK&#125;</span>&quot;</span>)</span>&quot;</span></span><br><span class="line">sed -i -r -e <span class="string">&quot;s|(PARTUUID=)\S+|\1<span class="variable">$&#123;ROOT_UUID&#125;</span>|g&quot;</span> /boot/grub/grub.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后重启</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>

<h3 id="软件安装"><a href="#软件安装" class="headerlink" title="软件安装"></a>软件安装</h3><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><p>安装后菜单不显示，尝试退出系统重新登陆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install docker dockerd luci-app-dockerman</span><br></pre></td></tr></table></figure>

<p>将 docker 区域设置为 lan 区域的目标区域，以便于可以在局域网中访问 docker 应用</p>
<p><img src="/posts/0d8a7ae7bced/0014.png"></p>
<h4 id="ttyd"><a href="#ttyd" class="headerlink" title="ttyd"></a>ttyd</h4><p>ttyd 是一个在线的命令行工具，安装 luci-i18n-ttyd-zh-cn 中文版本，会显示在系统菜单中，如果不显示重启设备。</p>
<h4 id="passwall"><a href="#passwall" class="headerlink" title="passwall"></a>passwall</h4><p>安装 passwall 插件， <strong>如果安装时提示 无法执行 opkg install 命令:SyntaxError: Unexpected end of JSON input 尝试更换其他的软件源再次尝试</strong></p>
<p>导入 x2ray 分享链接后，<strong>一定要把节点配置中 [域名] 和 [WebSocket Host] 都设置为分享链接中的域名，并在基本设置中开启主开关，选择节点后才能使用</strong>。如果配置正确还是不能使用，重新启动后再次使用。</p>
<p><img src="/posts/0d8a7ae7bced/0010.png"></p>
<h4 id="DDns"><a href="#DDns" class="headerlink" title="DDns"></a>DDns</h4><p>由于家庭网络等外界因素，导致 IP 会不定时的修改，如果想要无论何时都能让 绑定的域名解析到当前 IP 上就需要 DDns 服务。</p>
<p>DDns 服务会定时在后台检测当前 IP 是否修改，如果 IP 已经发生变动，DDns 服务会发送请求通知域名服务商，重新绑定域名解析的 IP 地址，从而实现动态域名解析。</p>
<p>在 OpenWrt 软件库中安装 ddns-go 和 luci-i18n-ddns-go-zh-cn 软件包, 可以方便的选择常用的运营商进行配置。</p>
<p>启用 ddns-go 服务并打开 web 界面， 跳转到 <a target="_blank" rel="noopener" href="https://console.dnspod.cn/account/token/apikey">腾讯云 DNDSPOD</a> 创建密钥。</p>
<p>IPv4 中选择通过网卡获取 IP， 并添加域名。</p>
<p><img src="/posts/0d8a7ae7bced/0011.png"></p>
<p>在运营商的域名解析页面，添加一条记录，先默认填入软路由的内网地址。</p>
<p><img src="/posts/0d8a7ae7bced/0012.png"></p>
<p>点击保存可以看到域名已经被正确的解析</p>
<p><img src="/posts/0d8a7ae7bced/0013.png"></p>
<h4 id="外网访问内网应用"><a href="#外网访问内网应用" class="headerlink" title="外网访问内网应用"></a>外网访问内网应用</h4><p>本设置的目的是使用不同的二级域名访问内网的各个应用，由于 OpenWrt 的防火墙只提供网络层的接口转发，而域名访问属于应用层，需要使用 nginx 作为反向代理工具代理域名请求并指向内网地址.<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/services/webserver/nginx">[说明文档]</a></p>
<p>完整的请求过程是，外网的 https 请求进入防火墙，防火墙放行 &#x3D;&gt; 软路由配置 nginx 监听指定域名和端口的请求 &#x3D;&gt; 转发请求到内网的其他服务器</p>
<ul>
<li><p>在 <strong>系统</strong> &#x3D;&gt; <strong>软件包</strong> 中安装 luci-nginx , 由于 luci-nginx 默认配置中包括强制将 http 重定向为 https 所以在软件安装后 OpenWrt 需要重新刷新登录。</p>
<blockquote>
<p>如果使用 ssh 工具登录时提示以下错误</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[user@hostname ~]$ ssh root@pong</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">@    WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED!     @</span><br><span class="line">@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@</span><br><span class="line">IT IS POSSIBLE THAT SOMEONE IS DOING SOMETHING NASTY!</span><br><span class="line">Someone could be eavesdropping on you right now (man-in-the-middle attack)!</span><br><span class="line">It is also possible that a host key has just been changed.</span><br><span class="line">The fingerprint <span class="keyword">for</span> the RSA key sent by the remote host is</span><br><span class="line">6e:45:f9:a8:af:38:3d:a1:a5:c7:76:1d:02:f8:77:00.</span><br><span class="line">Please contact your system administrator.</span><br><span class="line">Add correct host key <span class="keyword">in</span> /home/hostname /.ssh/known_hosts to get rid of this message.</span><br><span class="line">Offending RSA key <span class="keyword">in</span> /var/lib/sss/pubconf/known_hosts:4</span><br><span class="line">RSA host key <span class="keyword">for</span> pong has changed and you have requested strict checking.</span><br><span class="line">Host key verification failed.</span><br></pre></td></tr></table></figure>

<p>可以使用以下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 移除 known_hosts 此 ip 的所有记录值</span></span><br><span class="line">ssh-keygen -R 192.168.3.10</span><br><span class="line"><span class="comment"># 也可以使用</span></span><br><span class="line"><span class="built_in">rm</span> ~/.ssh/known_hosts</span><br></pre></td></tr></table></figure>

<p>如果使用的是 ttyd 插件，可以在 ttyd 配置中开启 ssl, 证书的默认路径是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/nginx/conf.d/_lan.crt</span><br><span class="line">/etc/nginx/conf.d/_lan.key</span><br></pre></td></tr></table></figure>
</blockquote>
<p>luci-nginx 使用 cui 统一了系统的配置，会通过 <code>/etc/config/nginx</code> 配置文件和模板文件(<code>/etc/nginx/uci.conf.template</code>) 生成 <code>/etc/nginx/uci.conf</code> 文件， <code>uci.conf</code> 文件最终会被 nginx 使用，并且 nginx 每次重启前都会重新生成此文件，因此不要手动更改生成的 <code>/etc/nginx/uci.conf</code> 文件中的内容。</p>
<p>如果想要保持 http 访问可以修改 <code>/etc/config/nginx</code> 配置文件中的内容，注释掉 _lan 和 _redirect2ssl 添加一个新的配置 http_lan</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">config main global</span><br><span class="line">      option uci_enable &#x27;true&#x27;</span><br><span class="line"></span><br><span class="line">#config server &#x27;_lan&#x27;</span><br><span class="line">#       list listen &#x27;443 ssl default_server&#x27;</span><br><span class="line">#       list listen &#x27;[::]:443 ssl default_server&#x27;</span><br><span class="line">#       option server_name &#x27;_lan&#x27;</span><br><span class="line">#       list include &#x27;restrict_locally&#x27;</span><br><span class="line">#       list include &#x27;conf.d/*.locations&#x27;</span><br><span class="line">#       option uci_manage_ssl &#x27;self-signed&#x27;</span><br><span class="line">#       option ssl_certificate &#x27;/etc/nginx/conf.d/_lan.crt&#x27;</span><br><span class="line">#       option ssl_certificate_key &#x27;/etc/nginx/conf.d/_lan.key&#x27;</span><br><span class="line">#       option ssl_session_cache &#x27;shared:SSL:32k&#x27;</span><br><span class="line">#       option ssl_session_timeout &#x27;64m&#x27;</span><br><span class="line">#       option access_log &#x27;off; # logd openwrt&#x27;</span><br><span class="line"></span><br><span class="line">#config server &#x27;_redirect2ssl&#x27;</span><br><span class="line">#       list listen &#x27;80&#x27;</span><br><span class="line">#       list listen &#x27;[::]:80&#x27;</span><br><span class="line">#       option server_name &#x27;_redirect2ssl&#x27;</span><br><span class="line">#       option return &#x27;302 https://$host$request_uri&#x27;</span><br><span class="line"></span><br><span class="line">config server &#x27;http_lan&#x27;</span><br><span class="line">        list listen &#x27;80&#x27;</span><br><span class="line">        list listen &#x27;[::]:80&#x27;</span><br><span class="line">        #注意不要添加这个配置规则</span><br><span class="line">        #因为限制了对nginx的访问地址为内网设备，会导致外网访问失效。</span><br><span class="line">        #list include &#x27;restrict_locally&#x27;</span><br><span class="line">        list include &#x27;conf.d/*.locations&#x27;</span><br></pre></td></tr></table></figure>

<p>使用命令 <code>service nginx reload</code> 重启 nginx, 这样就恢复了 http 访问</p>
<blockquote>
<p>重启过程中会提示错误, 可以按照提示使用 nginx -T -c ‘&#x2F;etc&#x2F;nginx&#x2F;uci.conf’ 命令测试配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ImmortalWrt:~# service nginx reload</span><br><span class="line">nginx_init: NOT using conf file!</span><br><span class="line">show config to be used by: nginx -T -c <span class="string">&#x27;/etc/nginx/uci.conf&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果文件报错会提示具体错误，并指明所在位置</p>
</blockquote>
</li>
<li><p>外网使用域名访问</p>
<p>目前的网络环境是，外网使用 _.iftrue.me 访问， 内网使用 _.iftrue.me 访问， 因此配置好外网的访问端口后，可以直接把内网的请求转发到外网的监听端口</p>
<p>首先配置外网域名解析， 在 cloudflare 选中域名 &#x3D;》 DNS 添加一条 AAAA 解析， Name 填入 * 表示泛域名， Content 地址临时填入一个 192.168.48.1 本地地址</p>
<p>添加 DDNS GO 解析将域名同步到 cloudflare ， 需要添加一个 cloudflare Api token ， Overview &#x3D;》Get your Api token &#x3D;》create token &#x3D;》 Edit zone DNS &#x3D;》选择对应的域名， 在 DDNS GO 中添加 token, 并解析域名</p>
<p>添加 cloudflare 规则， Rules &#x3D;》 Overview &#x3D;》 添加 Origin Rules &#x3D;》 可以将对域名的请求转发到特定的端口</p>
<p>创建一个 Origin Certificates 用于 Origin server 和 cloudflare 之间的验证， SSL&#x2F;TSL &#x3D;&gt; Origin Certificates, 保存 PEM 和 KEY</p>
<p>修改 uci 模板 <code>/etc/nginx/uci.conf.template</code>,在 http 模块中添加 ssl 通用配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ssl_certificate /etc/nginx/conf.d/_lan.crt;</span><br><span class="line">ssl_certificate_key /etc/nginx/conf.d/_lan.key;</span><br><span class="line"></span><br><span class="line">ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure>

<p>将证书传到服务器的执行目录下</p>
<blockquote>
<p>如果使用 scp 命令包错 <code>ash: /usr/libexec/sftp-server: not found</code>, 需要在软件包中安装 sftp-server</p>
</blockquote>
<p>配置一个反向代理的案例，&#x2F;etc&#x2F;nginx&#x2F;conf.d&#x2F;openwrt.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen      9348 ssl;</span><br><span class="line">    listen [::]:9348 ssl;</span><br><span class="line"></span><br><span class="line">    # qb.iftrue.me 用于内网域名的请求</span><br><span class="line">    server_name qb.iftrue.me qb.iftrue.me;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://192.168.48.189:10095;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后需要防火墙放行外网请求，Incoming <strong>Ipv6</strong> from <strong>Wan</strong> to <strong>this device</strong> ,port <strong>9348</strong></p>
</li>
<li><p>内网使用域名访问</p>
<p><del>给 openwrt lan 配置一个额外的 ip 用于转发，将 内网域名全部解析到此 ip， nginx 监听 443 端口，并将所有请求转发到外网的反向代理配置中</del></p>
<p>Network &#x3D;》 DHCP DNS &#x3D;》 添加地址 &#x2F;iftrue.me&#x2F;192.168.48.3 把 *.iftrue.me 解析到 192.168.48.3</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># 添加一个默认规则，如果所有的都没有匹配走404</span><br><span class="line">server &#123;</span><br><span class="line">  listen 9348 default_server;</span><br><span class="line">  listen [::]:9348 default_server;</span><br><span class="line">  server_name _;</span><br><span class="line"></span><br><span class="line">  return 404;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen      443 ssl;</span><br><span class="line">    listen [::]:443 ssl;</span><br><span class="line">    server_name *.iftrue.me;</span><br><span class="line"></span><br><span class="line">    ssl_certificate /etc/nginx/conf.d/_club.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/conf.d/_club.key;</span><br><span class="line"></span><br><span class="line">    ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    ssl_session_cache shared:SSL:10m;</span><br><span class="line">    ssl_session_timeout 10m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass https://192.168.48.1:9348;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line"></span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection &quot;upgrade&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="OpenVPN"><a href="#OpenVPN" class="headerlink" title="OpenVPN"></a>OpenVPN</h4><p>软件包中安装 luci-app-openvpn-server</p>
<ul>
<li>协议 udp ipv4</li>
<li>端口 1194</li>
<li>客户端网段： 自动</li>
<li>客户端推送配置<br>comp-lzo adaptive<br>redirect-gateway def1 bypass-dhcp<br>dhcp-option DNS 192.168.48.1 （填写 openWrt 的 IP）<br>route 192.168.48.0 255.255.255.0 （填写 openWrt 的 网段，最后一位需要是 0）</li>
<li>下载客户端配置文件，客户端安装 openvpn, 配置存放在 user&#x2F;openvpn&#x2F;client.opvn</li>
</ul>
<blockquote>
<p>可以重新生成证书文件，时间比较长，需要等待浏览器加载结束</p>
</blockquote>
<p>点击网络接口，重新加载会多出一个 vpn0 的接口</p>
<p>编辑配置文件，允许多个客户端链接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/config/openvpn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加配置</span></span><br><span class="line">option duplicate_cn <span class="string">&quot;1&quot;</span></span><br></pre></td></tr></table></figure>

<p>配置 NAT 转发规则，允许访问内网设备，网络 &#x3D;&gt; 防火墙 &#x3D;&gt; NAT 规则</p>
<blockquote>
<p>openWrt 23.05.4 以及以后版本不需要配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 POSTROUTING 进行规则转发</span></span><br><span class="line">iptables -t nat -A POSTROUTING -o br-lan -j MASQUERADE</span><br></pre></td></tr></table></figure>

<h4 id="HomeProxy-自定义路由"><a href="#HomeProxy-自定义路由" class="headerlink" title="HomeProxy 自定义路由"></a>HomeProxy 自定义路由</h4><ul>
<li><p>创建路由节点，可以定义流量使用哪个 vpn 代理，一定要先设置，因为默认出站会用到这些节点。<br>节点的出站选择<strong>直接出站</strong></p>
</li>
<li><p>创建 DNS 服务</p>
<p>标签: Google</p>
<p>类型: HTTPS</p>
<p>地址: dns.google</p>
<p>路径: &#x2F;dns-query</p>
<p>端口: 443</p>
<p>出站: 选择路由节点中最稳定的节点（BWG）</p>
</li>
<li><p>DNS 设置</p>
<p>默认策略: 仅 IPV4</p>
<p>默认 DNS 服务器: Google</p>
<p>缓存: 关闭</p>
<p>EDNS 客户端子网： （202.101.172.36 浙江） 选择一个距离当前宽带运营商最近的一个 IP 地址，这可以让 Google DNS 查询的时候选择一个离运营商最近的服务器</p>
</li>
<li><p>路由设置</p>
<p>路由模式: 自定义路由</p>
<p>绕过国内流量: 开启，可以在防火墙就直接转发国内流量，性能更好</p>
<p>复写目标地址: 一般用于视频网站解锁，Google DNS 获取到了目标 IP，sing-box 通过嗅探获取到了 netflix 域名，发送的目标是代理服务器，发送数据中的内容为请求 netflix 的 IP 以及 netflix 网站的域名，当代理受到这个请求后发现当前服务器不支持解锁，导致访问失败<br>开启复写后，发送数据中的目标地址变为 netflix 域名，当发送到代理服务器后会在代理服务器的环境中做 DNS 解析， 它获取到的不是真实 IP, 而是专门的反代服务器 IP 用于解锁。</p>
<p>默认出站: 选择路由节点中最稳定的节点（BWG）</p>
<p>默认 DNS 出站： Google</p>
</li>
<li><p>规则集</p>
<p><a target="_blank" rel="noopener" href="https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/sing/geo-lite/geoip/cn.srs">https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/sing/geo-lite/geoip/cn.srs</a> 国内 ip<br><a target="_blank" rel="noopener" href="https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/sing/geo-lite/geosite/cn.srs">https://github.com/MetaCubeX/meta-rules-dat/raw/refs/heads/sing/geo-lite/geosite/cn.srs</a> 国内网址<br><a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/xmdhs/sing-box-ruleset/rule-set/AdGuardSDNSFilterSingBox.srs">https://raw.githubusercontent.com/xmdhs/sing-box-ruleset/rule-set/AdGuardSDNSFilterSingBox.srs</a> 广告网址</p>
<p>出站选择默认，这会使用路由设置中的默认出站用于访问这些资源。</p>
</li>
<li><p>路由规则</p>
<p>直连，选择国内的两个规则集<br>内网设备，可以通过 IP 来指定一个路由规则，以便于在出站时使用其他的代理 vpn</p>
</li>
<li><p>DNS 规则</p>
<p>Block，选择广告的资源集，在 DNS 解析的时候就禁止访问<br>直连，选择国内的域名规则集，DNS 服务器选择 WAN 自动下发的 DNS 服务，这样当请求一个国内的域名时，可以直接用运营商的 DNS 解析</p>
</li>
</ul>
<h4 id="WireGuard"><a href="#WireGuard" class="headerlink" title="WireGuard"></a>WireGuard</h4><p>安装 luci-proto-wireguard  qrencode</p>
<p>Netword &#x3D;》 Interfaces &#x3D;》新建协议 Wireguard Vpn</p>
<p>通用设置 &#x3D;》 生成新的密钥对 &#x3D;》 添加监听端口 &#x3D;》Ip 地址选择一个与内网不冲突的网段 10.0.6.0</p>
<p>防火墙设置 &#x3D;》 加入 lan 区域</p>
<p>对端设置 &#x3D;》 创建新的密钥对 &#x3D;》ip 地址选择一个网段内的 ip &#x3D;》生成二维码 &#x3D;》修改链接地址为配置了 DDNS 的域名 &#x3D;》扫描二维码或复制配置添加</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OpenWrt/" rel="tag">OpenWrt</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/O2OA私有化部署"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/682c074451f7/"
    >O2OA 私有化部署</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/682c074451f7/" class="article-date">
  <time datetime="2024-09-22T04:02:05.000Z" itemprop="datePublished">2024-09-22</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="安装-mysql-数据库"><a href="#安装-mysql-数据库" class="headerlink" title="安装 mysql 数据库"></a>安装 mysql 数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装服务</span></span><br><span class="line"><span class="built_in">sudo</span> apt install -y mysql-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查服务是否启动</span></span><br><span class="line">systemctl status mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首次登录没有密码</span></span><br><span class="line"><span class="built_in">sudo</span> mysql -u root -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建对应的数据库</span></span><br><span class="line"></span><br><span class="line">CREATE DATABASE my_database</span><br><span class="line">CHARACTER SET utf8mb4</span><br><span class="line">COLLATE utf8mb4_general_ci;</span><br><span class="line"><span class="comment"># 查看所有数据库</span></span><br><span class="line">SHOW DATABASES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据库</span></span><br><span class="line">DROP DATABASE database_name;</span><br><span class="line"><span class="comment"># 修改字符集和排序</span></span><br><span class="line">ALTER DATABASE database_name</span><br><span class="line">CHARACTER SET utf8mb4</span><br><span class="line">COLLATE utf8mb4_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建新用户</span></span><br><span class="line"><span class="comment"># &#x27;localhost&#x27;：表示该用户只能从本地机器连接到数据库。如果希望该用户可以从任何主机连接，可以使用 &#x27;%&#x27;，如 &#x27;new_user&#x27;@&#x27;%&#x27;。</span></span><br><span class="line">CREATE USER <span class="string">&#x27;new_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;your_password&#x27;</span>;</span><br><span class="line"><span class="comment"># 查看所有用户</span></span><br><span class="line">SELECT User, Host FROM mysql.user;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#ALL PRIVILEGES：赋予所有权限。</span></span><br><span class="line"><span class="comment"># my_database.*：指示该用户可以对 my_database 数据库中的所有表进行操作。</span></span><br><span class="line"><span class="comment"># &#x27;localhost&#x27;：表示该用户只能从本地连接。</span></span><br><span class="line">GRANT ALL PRIVILEGES ON my_database.* TO <span class="string">&#x27;new_user&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新权限</span></span><br><span class="line">FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看端口</span></span><br><span class="line">SHOW VARIABLES LIKE <span class="string">&#x27;port&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> /etc/mysql/mysql.conf.d/mysqld.cnf</span><br></pre></td></tr></table></figure>

<h4 id="下载安装包"><a href="#下载安装包" class="headerlink" title="下载安装包"></a>下载安装包</h4><p><a target="_blank" rel="noopener" href="http://www.o2oa.net/download.html">下载</a> 安装包</p>
<p>解压并复制到 &#x2F;opt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unzip  o2server-8.2.3-linux-x64.zip</span><br><span class="line"></span><br><span class="line"><span class="built_in">mv</span> o2server /opt</span><br></pre></td></tr></table></figure>

<h4 id="配置服务器端口"><a href="#配置服务器端口" class="headerlink" title="配置服务器端口"></a>配置服务器端口</h4><p>O2OA 服务器端口配置文件所在位置：o2server&#x2F;config&#x2F;node_127.0.0.1.json</p>
<p>如果目录里没有该文件或者没有 config 目录，可以新建一个 config 目录，然后从 configSample 目录里 COPY 一个到新建的 config 目录下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自行修改web端口配置</span></span><br></pre></td></tr></table></figure>

<h4 id="自启动服务"><a href="#自启动服务" class="headerlink" title="自启动服务"></a>自启动服务</h4><p>因为需要用 root 用户启动服务，所以先配置开机启动服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./service_linux.sh o2server start_linux.sh</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> o2server</span><br><span class="line">systemctl start o2server</span><br></pre></td></tr></table></figure>

<h4 id="配置数据库链接"><a href="#配置数据库链接" class="headerlink" title="配置数据库链接"></a>配置数据库链接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql://127.0.0.1:3306/o2oa_db?autoReconnect=<span class="literal">true</span>&amp;allowPublicKeyRetrieval=<span class="literal">true</span>&amp;useSSL=<span class="literal">false</span>&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=UTF-8&amp;useLegacyDatetimeCode=<span class="literal">false</span>&amp;serverTimezone=GMT%2B8</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/o2oa/" rel="tag">o2oa</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-javascript/threejs"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/38aeea3b300c/"
    >Three.js 基础</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/38aeea3b300c/" class="article-date">
  <time datetime="2024-08-30T01:13:10.000Z" itemprop="datePublished">2024-08-30</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Three-js/">Three.js</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="模型类型"><a href="#模型类型" class="headerlink" title="模型类型"></a>模型类型</h4><p>.fbx</p>
<p>FBX 是 FilmBoX 这套软件所使用的格式，后改称 Motionbuilder。因为 Motionbuilder 扮演的是动作制作的平台，所以在前端的 modeling 和后端的 rendering 也都有赖于其它软件的配合，所以 Motionbuilder 在档案的转换上自然下了一番功夫。</p>
<p>FBX 最大的用途是用在诸如在 Max、Maya、Softimage 等软件间进行模型、材质、动作和摄影机信息的互导，这样就可以发挥 Max 和 Maya 等软件的优势。可以说，FBX 方案是非常好的互导方案。</p>
<p>.glTF</p>
<p>glTF 是一种可以减少 3D 格式中与渲染无关的冗余数据并且在更加适合 OpenGL 簇加载的一种 3D 文件格式。glTF 的提出是源自于 3D 工业和媒体发展的过程中，对 3D 格式统一化的急迫需求。如果用一句话来描述：glTF 就是三维文件的 JPEG ，三维格式的 MP3。在没有 glTF 的时候，大家都要花很长的的时间来处理模型的载入。</p>
<p>很多的游戏引擎或者工控渲染引擎，都使用的是插件的方式来载入各种格式的模型。可是，各种格式的模型都包含了很多无关的信息。就 glTF 格式而言，虽然以前有很多 3D 格式，但是各种 3D 模型渲染程序都要处理很多种的格式。对于那些对载入格式不是那么重要的软件，可以显著减少代码量，所以也有人说，最大的受益者是那些对程序大小敏感的 3D Web 渲染引擎，只需要很少的代码就可以顺利地载入各种模型了。</p>
<p>此外，glTF 是对近二十年来各种 3D 格式的总结，使用最优的数据结构，来保证最大的兼容性以及可伸缩性。这就好比是本世纪初 xml 的提出。glTF 使用 json 格式进行描述，也可以编译成二进制的内容：bglTF。glTF 可以包括场景、摄像机、动画等，也可以包括网格、材质、纹理，甚至包括了渲染技术（technique）、着色器以及着色器程序。同时由于 json 格式的特点，它支持预留一般以及特定供应商的扩展。</p>
<p>.obj</p>
<p>OBJ 文件是 Alias|Wavefront 公司为它的一套基于工作站的 3D 建模和动画软件”Advanced Visualizer”开发的一种标准 3D 模型文件格式，很适合用于 3D 软件模型之间的互导。目前几乎所有知名的 3D 软件都支持 OBJ 文件的读写。OBJ 文件是一种文本文件，可以直接用写字板打开进行查看和编辑修改。</p>
<h4 id="物体-位移-x2F-缩放-x2F-旋转"><a href="#物体-位移-x2F-缩放-x2F-旋转" class="headerlink" title="物体 位移&#x2F;缩放&#x2F;旋转"></a>物体 位移&#x2F;缩放&#x2F;旋转</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cube.<span class="property">position</span>.<span class="property">x</span> = <span class="number">0</span>;</span><br><span class="line">cube.<span class="property">position</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">cube.<span class="property">scale</span>.<span class="property">y</span> = <span class="number">1</span>;</span><br><span class="line">cube.<span class="property">scale</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">cube.<span class="property">rotate</span>.<span class="property">z</span> = <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>;</span><br><span class="line">cube.<span class="property">rotate</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span> / <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p>一个物体的 <code>position/scale/rotate</code> 属性描述一个物体的 位置&#x2F;缩放&#x2F;旋转，当这个物体再世界坐标系中，那么他的 位移&#x2F;缩放&#x2F;旋转 相对于世界坐标系。</p>
<p>如果物体在另一个物体中，那么他的 位移&#x2F;缩放&#x2F;旋转 相对于父元素的位置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由于物体位置相对于父元素，因此cube在坐标原点</span></span><br><span class="line">parentCube.<span class="title function_">add</span>(cube);</span><br><span class="line">parentCube.<span class="property">position</span>.<span class="property">x</span> = -<span class="number">3</span>;</span><br><span class="line">cube.<span class="property">position</span>.<span class="property">x</span> = <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<h4 id="画布适应窗口的变化"><a href="#画布适应窗口的变化" class="headerlink" title="画布适应窗口的变化"></a>画布适应窗口的变化</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;resize&quot;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 更新摄像头宽高比</span></span><br><span class="line">  camera.<span class="property">aspect</span> = <span class="variable language_">window</span>.<span class="property">innerWidth</span> / <span class="variable language_">window</span>.<span class="property">innerHeight</span>;</span><br><span class="line">  <span class="comment">// 更新摄像机的投影矩阵</span></span><br><span class="line">  camera.<span class="title function_">updateProjectionMatrix</span>();</span><br><span class="line">  <span class="comment">// 更新渲染器</span></span><br><span class="line">  renderer.<span class="title function_">setSize</span>(<span class="variable language_">window</span>.<span class="property">innerWidth</span>, <span class="variable language_">window</span>.<span class="property">innerHeight</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="通过-GUI-快速调试参数"><a href="#通过-GUI-快速调试参数" class="headerlink" title="通过 GUI 快速调试参数"></a>通过 GUI 快速调试参数</h4><p>通过安装 <code>dat.gui</code> （不推荐）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> dat <span class="keyword">from</span> <span class="string">&quot;dat.gui&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>新方法是使用 <code>threejs</code> 自带的 GUI (推荐)</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="variable constant_">GUI</span> &#125; <span class="keyword">from</span> <span class="string">&quot;three/examples/jsm/libs/lil-gui.module.min&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> gui = <span class="keyword">new</span> <span class="title function_">GUI</span>();</span><br><span class="line"><span class="keyword">const</span> handle = &#123;</span><br><span class="line">  <span class="attr">click</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;click&quot;</span>),</span><br><span class="line">  <span class="attr">fullscreen</span>: <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;fullscreen&quot;</span>),</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 添加两个按钮，点击和全屏</span></span><br><span class="line">gui.<span class="title function_">add</span>(handle, <span class="string">&quot;click&quot;</span>).<span class="title function_">name</span>(<span class="string">&quot;点击&quot;</span>);</span><br><span class="line">gui.<span class="title function_">add</span>(handle, <span class="string">&quot;fullscreen&quot;</span>).<span class="title function_">name</span>(<span class="string">&quot;全屏&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//修改数值,最小值-10，最大值10，步长1</span></span><br><span class="line">gui.<span class="title function_">add</span>(cube.<span class="property">position</span>, <span class="string">&quot;x&quot;</span>).<span class="title function_">name</span>(<span class="string">&quot;x轴位置&quot;</span>).<span class="title function_">min</span>(-<span class="number">10</span>).<span class="title function_">max</span>(<span class="number">10</span>).<span class="title function_">step</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//使用 folder 分组</span></span><br><span class="line"><span class="keyword">let</span> folder = gui.<span class="title function_">addFolder</span>(<span class="string">&quot;按钮组&quot;</span>);</span><br><span class="line">folder.<span class="title function_">add</span>(handle, <span class="string">&quot;click&quot;</span>).<span class="title function_">name</span>(<span class="string">&quot;点击&quot;</span>);</span><br><span class="line">folder.<span class="title function_">add</span>(handle, <span class="string">&quot;fullscreen&quot;</span>).<span class="title function_">name</span>(<span class="string">&quot;全屏&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//事件</span></span><br><span class="line">gui.<span class="title function_">add</span>(handle, <span class="string">&quot;click&quot;</span>).<span class="title function_">onChange</span>(noop).<span class="title function_">onFinishChange</span>(noop);</span><br><span class="line"></span><br><span class="line"><span class="comment">//颜色</span></span><br><span class="line"><span class="keyword">const</span> colors = &#123;</span><br><span class="line">  <span class="attr">cubeColor</span>: <span class="string">&quot;#ff0000&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line">gui</span><br><span class="line">  .<span class="title function_">addColor</span>(colors, <span class="string">&quot;cubeColor&quot;</span>)</span><br><span class="line">  .<span class="title function_">name</span>(<span class="string">&quot;颜色&quot;</span>)</span><br><span class="line">  .<span class="title function_">onChange</span>(<span class="function">() =&gt;</span> cube.<span class="property">material</span>.<span class="property">color</span>.<span class="title function_">set</span>(val));</span><br></pre></td></tr></table></figure>

<h4 id="Geometry-几何体"><a href="#Geometry-几何体" class="headerlink" title="Geometry 几何体"></a>Geometry 几何体</h4><h5 id="顶点-x2F-索引"><a href="#顶点-x2F-索引" class="headerlink" title="顶点&#x2F;索引"></a>顶点&#x2F;索引</h5><p>threejs 中使用 <code>position</code> 中<strong>类型化数组</strong>描述顶点的位置信息。三个为一组，绘制时会将一组顶点绘制为一个三角形，复杂的几何体也是由多个三角形构成。</p>
<p>顶点的排列顺序(<strong>绕序</strong>)影响绘制的效果，逆时针 (Counter Clockwise, CCW) 排列的面视为正面， 顺时针排列视为反面。模型情况下，背面不会渲染以便提高性能。</p>
<p>Three.js 使用相机的视角和顶点位置之间的关系来判断一个面是正面还是反面。当从相机位置看时，顶点按照逆时针排列的面会被认为是正面；相反，顺时针排列的面会被认为是背面。顶点顺序的判断依赖于面法向量（normal vector）。法向量是垂直于面的一个矢量，它通过面顶点的排列顺序来决定。如果法向量指向相机方向，面被认为是正面，否则是反面。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> position = <span class="keyword">new</span> <span class="title class_">Float32Array</span>([</span><br><span class="line">  <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>,</span><br><span class="line">]);</span><br><span class="line"><span class="keyword">const</span> geometry = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BufferGeometry</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> indices = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>();</span><br><span class="line">geometry.<span class="title function_">setAttribute</span>(<span class="string">&quot;position&quot;</span>, <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BufferAttribute</span>(position, <span class="number">3</span>));</span><br><span class="line"><span class="keyword">const</span> mesh = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(geometry, material);</span><br></pre></td></tr></table></figure>

<p>但是查看 <code>position</code> 属性会发现有 6 个顶点，这时可以通过建立索引，共用顶点优化顶点数量。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 去除掉可以公用的顶点，</span></span><br><span class="line"><span class="keyword">const</span> position = <span class="keyword">new</span> <span class="title class_">Float32Array</span>([<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用索引来描述</span></span><br><span class="line"><span class="keyword">const</span> indices = <span class="keyword">new</span> <span class="title class_">Uint16Array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">1</span>]);</span><br><span class="line">geometry.<span class="title function_">setIndex</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BufferAttribute</span>(indices, <span class="number">1</span>));</span><br></pre></td></tr></table></figure>

<h5 id="顶点分组"><a href="#顶点分组" class="headerlink" title="顶点分组"></a>顶点分组</h5><p>为几何体的顶点分组，可以为每个组设置单独的材质。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">geometry.<span class="title function_">addGroup</span>(<span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>); <span class="comment">// 开始位置，数量，材质索引</span></span><br><span class="line">geometry.<span class="title function_">addGroup</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mesh = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(geometry, [material, material2]);</span><br></pre></td></tr></table></figure>

<h5 id="顶点转换"><a href="#顶点转换" class="headerlink" title="顶点转换"></a>顶点转换</h5><p>对几何体的顶点操作（position, rotate, translate）通常是不推荐的，这会改变几何体原有的顶点信息（attribute.position）, 通常在物体（Mesh）上修改。</p>
<h5 id="UV"><a href="#UV" class="headerlink" title="UV"></a>UV</h5><p>UV 决定了 2D 纹理如何映射到 3D 空间中，U V 分别代表 2D 纹理的横纵坐标（为了与 3D 中的 X Y Z 坐标区分）。在模型建好之后会将纹理展开到 2D 平面中,这一过程叫做 UV 展开。常用的算法有投影展开法（Projection Mapping）,迭代展开法（Iterative Unwrapping）,Least Squares Conformal Mapping (LSCM) 和 Angle-Based Flattening (ABF) 等。</p>
<p>如果一个物体缺失 UV 信息，那么纹理将无法映射到物体表面。如果 UV 坐标没有覆盖（1，1）区域，剩余位置颜色会自动按 UV 坐标边缘采集。</p>
<h5 id="法线"><a href="#法线" class="headerlink" title="法线"></a>法线</h5><p>法线是垂直与平面的向量，决定了光纤如何反射。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 法线辅助器</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VertexNormalsHelper</span> &#125; <span class="keyword">from</span> <span class="string">&quot;three/examples/jsm/helpers/VertexNormalsHelper.js&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> geometry = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BufferGeometry</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 自动计算法线</span></span><br><span class="line">geometry.<span class="title function_">computeVertexNormals</span>();</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="comment">// 添加法线辅助器</span></span><br><span class="line"><span class="keyword">const</span> helper = <span class="keyword">new</span> <span class="title class_">VertexNormalsHelper</span>(mesh, <span class="number">0.2</span>, <span class="number">0x00ff00</span>);</span><br><span class="line">scene.<span class="title function_">add</span>(helper);</span><br></pre></td></tr></table></figure>

<h5 id="包围盒"><a href="#包围盒" class="headerlink" title="包围盒"></a>包围盒</h5><p>包围盒用于可视化的检视物体，或用于碰撞检测。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">fbxLoader.<span class="title function_">load</span>(floorFbx, <span class="keyword">function</span> (<span class="params">group</span>) &#123;</span><br><span class="line">  <span class="comment">// 通过名称或ID查找到模型中指定的物体</span></span><br><span class="line">  <span class="keyword">const</span> mesh = group.<span class="title function_">getObjectById</span>(<span class="number">40</span>);</span><br><span class="line">  <span class="comment">// const mesh =  group.getObjectByName(&#x27;a23&#x27;)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由于物体的父级可能存在几何变化导致与物体的尺寸不同，因此需要更新物体的世界矩阵</span></span><br><span class="line">  <span class="comment">//                    更新父级， 更新子集</span></span><br><span class="line">  mesh.<span class="title function_">updateWorldMatrix</span>(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 需要手动调用几何体包围盒计算函数</span></span><br><span class="line">  <span class="keyword">const</span> geometry = mesh.<span class="property">geometry</span>;</span><br><span class="line">  geometry.<span class="title function_">computeBoundingBox</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取包围盒计算结果</span></span><br><span class="line">  <span class="keyword">const</span> box = geometry.<span class="property">boundingBox</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用世界矩阵更新包围盒</span></span><br><span class="line">  box.<span class="title function_">applyMatrix4</span>(mesh.<span class="property">matrixWorld</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建包围盒辅助器显示包围盒</span></span><br><span class="line">  <span class="keyword">const</span> boxHelper = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3Helper</span>(box, <span class="number">0xff0000</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加到场景中</span></span><br><span class="line">  scene.<span class="title function_">add</span>(boxHelper);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>多个物体包围盒</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mesh = group.<span class="title function_">getObjectById</span>(<span class="number">40</span>);</span><br><span class="line"><span class="keyword">const</span> mesh1 = group.<span class="title function_">getObjectById</span>(<span class="number">41</span>);</span><br><span class="line"><span class="keyword">const</span> mesh2 = group.<span class="title function_">getObjectById</span>(<span class="number">42</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxUnion = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3</span>();</span><br><span class="line">[mesh, mesh1, mesh2].<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">  mesh.<span class="title function_">updateWorldMatrix</span>(<span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">const</span> geometry = mesh.<span class="property">geometry</span>;</span><br><span class="line">  geometry.<span class="title function_">computeBoundingBox</span>();</span><br><span class="line">  <span class="keyword">const</span> box = geometry.<span class="property">boundingBox</span>;</span><br><span class="line">  box.<span class="title function_">applyMatrix4</span>(mesh.<span class="property">matrixWorld</span>);</span><br><span class="line">  <span class="keyword">const</span> boxHelper = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3Helper</span>(box, <span class="number">0xff0000</span>);</span><br><span class="line">  scene.<span class="title function_">add</span>(boxHelper);</span><br><span class="line"></span><br><span class="line">  boxUnion.<span class="title function_">union</span>(box);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxHelper = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3Helper</span>(boxUnion, <span class="number">0xff0000</span>);</span><br><span class="line">scene.<span class="title function_">add</span>(boxHelper);</span><br></pre></td></tr></table></figure>

<p>使用 setFromObject，自动计算和世界轴对齐的一个对象 Object3D （含其子对象）的包围盒，计算对象和子对象的世界坐标变换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> boxUnion = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3</span>();</span><br><span class="line">[mesh, mesh1, mesh2].<span class="title function_">forEach</span>(<span class="function">(<span class="params">mesh</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> box = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3</span>().<span class="title function_">setFromObject</span>(mesh);</span><br><span class="line">  <span class="keyword">const</span> boxHelper = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3Helper</span>(box, <span class="number">0xff0000</span>);</span><br><span class="line">  scene.<span class="title function_">add</span>(boxHelper);</span><br><span class="line">  boxUnion.<span class="title function_">union</span>(box);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxHelper = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Box3Helper</span>(boxUnion, <span class="number">0xff0000</span>);</span><br><span class="line">scene.<span class="title function_">add</span>(boxHelper);</span><br></pre></td></tr></table></figure>

<h5 id="几何体居中-x2F-获取中心"><a href="#几何体居中-x2F-获取中心" class="headerlink" title="几何体居中&#x2F;获取中心"></a>几何体居中&#x2F;获取中心</h5><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 会将几何体的中心放到世界中心</span></span><br><span class="line">geometry.<span class="title function_">center</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 但是Mesh对象可能有几何变换，导致物体看上去仍然偏移</span></span><br><span class="line"><span class="comment">// 需要重置Mesh的几何信息</span></span><br><span class="line">mesh.<span class="property">position</span>.<span class="title function_">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取包围盒的中心点</span></span><br><span class="line"><span class="keyword">const</span> vec3 = box.<span class="title function_">getCenter</span>(<span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Vector3</span>());</span><br></pre></td></tr></table></figure>

<h4 id="边缘几何体-x2F-线框几何体"><a href="#边缘几何体-x2F-线框几何体" class="headerlink" title="边缘几何体&#x2F;线框几何体"></a>边缘几何体&#x2F;线框几何体</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过名称或ID查找到模型中指定的物体</span></span><br><span class="line"><span class="keyword">const</span> mesh = group.<span class="title function_">getObjectById</span>(<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> geometry = mesh.<span class="property">geometry</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建边缘几何体</span></span><br><span class="line"><span class="keyword">const</span> edgeGeometry = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">EdgesGeometry</span>(geometry);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线框几何体</span></span><br><span class="line"><span class="comment">// const wireGeometry = new THREE.WireframeGeometry(geometry);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线段材质</span></span><br><span class="line"><span class="keyword">const</span> lineMaterial = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">LineBasicMaterial</span>(&#123;</span><br><span class="line">  <span class="attr">color</span>: <span class="number">0xffffff</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建线段物体</span></span><br><span class="line"><span class="keyword">const</span> lineMesh = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">LineSegments</span>(edgeGeometry, lineMaterial);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由于新创建的物体丢失了源物体的世界矩阵信息，因此位置大小可能表现不同</span></span><br><span class="line"><span class="comment">// 需要使用源物体的世界矩阵信息重新赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新源物体的世界矩阵信息</span></span><br><span class="line"><span class="comment">// mesh.updateWorldMatrix();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 应用源物体的世界矩阵</span></span><br><span class="line">lineMesh.<span class="property">matrix</span>.<span class="title function_">copy</span>(mesh.<span class="property">matrixWorld</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//将矩阵信息解构到物体的变换信息上</span></span><br><span class="line">lineMesh.<span class="property">matrix</span>.<span class="title function_">decompose</span>(</span><br><span class="line">  lineMesh.<span class="property">position</span>,</span><br><span class="line">  lineMesh.<span class="property">quaternion</span>,</span><br><span class="line">  lineMesh.<span class="property">scale</span></span><br><span class="line">);</span><br><span class="line">scene.<span class="title function_">add</span>(lineMesh);</span><br></pre></td></tr></table></figure>

<h4 id="材质与纹理"><a href="#材质与纹理" class="headerlink" title="材质与纹理"></a>材质与纹理</h4><p>three.js 中的材质就是几何体表面的材料。所有材质均继承自 Material。ThreeJS 的材质分为：基础材质、深度材质、法向量材质、琥珀材质、冯氏材质、标准材质、着色器材质、基础线材质以及虚线材质。材质就像物体的皮肤，让几何体看起来像金属还是木板，是否透明，什么颜色。</p>
<p>纹理的基类是 Texture，通过给其属性 Image 传入一个图片从而构造出一个纹理。纹理是材质的属性，材质和几何体 Gemotry 构成 Mesh</p>
<h5 id="材质基类-Material"><a href="#材质基类-Material" class="headerlink" title="材质基类 Material"></a>材质基类 Material</h5><ul>
<li>transparent: 定义此材质是否透明,可以配合 opacity 使用，控制透明程度。</li>
</ul>
<h5 id="纹理基类（Texture）"><a href="#纹理基类（Texture）" class="headerlink" title="纹理基类（Texture）"></a>纹理基类（Texture）</h5><ul>
<li><p>colorSpace</p>
<p>1.THREE.NoColorSpace: 这意味着没有应用任何特定的颜色空间，纹理的颜色数据会被原样使用。这个选项通常用于已经处于需要的颜色空间中的纹理，或者那些不依赖于颜色空间的特定用途。</p>
<p>2.THREE.SRGBColorSpace:在此颜色空间中，颜色数据以 SRGB 格式存储。SRGB 是一个 RGB 标准，它试图将色彩的表现和人眼感知到的颜色更好地匹配。相对于线性颜色空间，SRGB 颜色空间在暗区提供了更多的颜色级别。使用此颜色空间时，需要注意图像的颜色可能会被转换为非线性的 SRGB 格式。</p>
<p>3.THREE.LinearSRGBColorSpace 这也是一个以 SRGB 格式存储颜色数据的颜色空间，但颜色数据被当作线线性性数据处理。在进行计算和处理时，这种颜色空间可以提供更精确的结果。但是由于人眼对光线的感知，50%感觉的亮度只需要 18%的发光强度，这可能导致物体颜色过浅。</p>
</li>
<li><p>needsUpdate 指定需要重新编译材质。如果动态设置纹理需要将此属性设置为<code>true</code>。</p>
</li>
</ul>
<h5 id="基础材质-MeshBasicMaterial"><a href="#基础材质-MeshBasicMaterial" class="headerlink" title="基础材质 MeshBasicMaterial"></a>基础材质 MeshBasicMaterial</h5><ul>
<li>map: 颜色贴图。默认会随几何体的大小拉伸。 <strong>开启 transparent 属性，会影响有透明通道图片的效果</strong>。</li>
</ul>
<h5 id="MeshMatcapMaterial"><a href="#MeshMatcapMaterial" class="headerlink" title="MeshMatcapMaterial"></a>MeshMatcapMaterial</h5><p>由一个材质捕捉（MatCap，或光照球（Lit Sphere））纹理定义。mapcap 编码了光照，颜色等信息，因此不对光照做出反应。可以投射阴影，但是不会接受阴影。<br>是一个低成本实现光照效果得材质，缺点是固定了光照信息，不能对光照反应。</p>
<h5 id="MeshLambertMaterial"><a href="#MeshLambertMaterial" class="headerlink" title="MeshLambertMaterial"></a>MeshLambertMaterial</h5><p>该材质使用基于非物理的 Lambertian 模型来计算反射率。 这可以很好地模拟一些表面（例如未经处理的木材或石材），但不能模拟具有镜面高光的光泽表面（例如涂漆木材）</p>
<h5 id="MeshPhongMaterial"><a href="#MeshPhongMaterial" class="headerlink" title="MeshPhongMaterial"></a>MeshPhongMaterial</h5><p>该材质使用非物理的 Blinn-Phong 模型来计算反射率。可以模拟高光的或玻璃效果，但是由于不是物理模型，因此玻璃效果不能与场景中其他物体作用，只能通过透明度设置。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现玻璃效果，只限于与环境光线相互作用</span></span><br><span class="line"><span class="comment">// 加载环境贴图是必须的，映射模式需要修改为折射</span></span><br><span class="line">envMap.<span class="property">mapping</span> = <span class="variable constant_">THREE</span>.<span class="property">EquirectangularRefractionMapping</span>;</span><br><span class="line"><span class="comment">// scene.environment = envMap;</span></span><br><span class="line"><span class="comment">// scene.background = envMap;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> box = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">BoxGeometry</span>(<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> bujianMatertal = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">MeshPhongMaterial</span>(&#123;</span><br><span class="line">  <span class="attr">refractionRatio</span>: <span class="number">0.7</span>, <span class="comment">// 空气的折射|反射率</span></span><br><span class="line">  <span class="comment">// 当设置为 THREE.EquirectangularRefractionMapping 值为折射系数</span></span><br><span class="line">  <span class="comment">// 越高越像玻璃</span></span><br><span class="line">  <span class="attr">reflectivity</span>: <span class="number">0.99</span>,</span><br><span class="line">  <span class="attr">envMap</span>: envMap,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> boxMesh = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Mesh</span>(box, bujianMatertal);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 必须要有环境光，与环境光相互作用</span></span><br><span class="line"><span class="keyword">const</span> light = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">AmbientLight</span>(<span class="number">0xffffff</span>, <span class="number">1</span>);</span><br><span class="line">scene.<span class="title function_">add</span>(light);</span><br></pre></td></tr></table></figure>

<h4 id="FOG-雾"><a href="#FOG-雾" class="headerlink" title="FOG 雾"></a>FOG 雾</h4><p>通常会把背景颜色和雾的颜色设置成相同颜色，可以让雾融入到场景中</p>
<h4 id="镭射光纤，选择物体"><a href="#镭射光纤，选择物体" class="headerlink" title="镭射光纤，选择物体"></a>镭射光纤，选择物体</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> raycaster = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Raycaster</span>();</span><br><span class="line"><span class="keyword">const</span> pointer = <span class="keyword">new</span> <span class="variable constant_">THREE</span>.<span class="title class_">Vector2</span>();</span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;pointermove&quot;</span>, onPointerMove);</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onPointerMove</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="comment">// 将鼠标位置归一化为设备坐标。x 和 y 方向的取值范围是 (-1 to +1)</span></span><br><span class="line">  pointer.<span class="property">x</span> = (event.<span class="property">clientX</span> / <span class="variable language_">window</span>.<span class="property">innerWidth</span>) * <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">  pointer.<span class="property">y</span> = -(event.<span class="property">clientY</span> / <span class="variable language_">window</span>.<span class="property">innerHeight</span>) * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">rayTest</span>(<span class="params"></span>) &#123;</span><br><span class="line">  raycaster.<span class="title function_">setFromCamera</span>(pointer, camera);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> intersects = raycaster.<span class="title function_">intersectObjects</span>(mesharr);</span><br><span class="line">  <span class="keyword">if</span> (intersects.<span class="property">length</span> === mesharr.<span class="property">length</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// intersects 是一个按深度排序的数组</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; intersects.<span class="property">length</span>; i++) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">animate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">rayTest</span>();</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="补间动画"><a href="#补间动画" class="headerlink" title="补间动画"></a>补间动画</h4><p>THREE.js 集成了 <a target="_blank" rel="noopener" href="https://github.com/tweenjs/tween.js/blob/main/docs/user_guide_zh-CN.md">Tween</a> 动画库</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Tween</span>, <span class="title class_">Easing</span> &#125; <span class="keyword">from</span> <span class="string">&quot;three/examples/jsm/libs/tween.module.js&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> tween = <span class="keyword">new</span> <span class="title class_">Tween</span>(mesh.<span class="property">position</span>);</span><br><span class="line"><span class="comment">// 移动到某个位置</span></span><br><span class="line">tween.<span class="title function_">to</span>(&#123; <span class="attr">x</span>: <span class="number">2</span> &#125;, <span class="number">1000</span>);</span><br><span class="line"><span class="comment">// 位置更新时回调</span></span><br><span class="line">tween.<span class="title function_">onUpdate</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// console.log(mesh.position.x);</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//重复次数</span></span><br><span class="line">tween.<span class="title function_">repeat</span>(<span class="number">10</span>);</span><br><span class="line"><span class="comment">// 是否往返</span></span><br><span class="line">tween.<span class="title function_">yoyo</span>(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// 是否延迟</span></span><br><span class="line">tween.<span class="title function_">delay</span>(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置缓动</span></span><br><span class="line">tween.<span class="title function_">easing</span>(<span class="title class_">Easing</span>.<span class="property">Bounce</span>.<span class="property">In</span>);</span><br><span class="line">tween.<span class="title function_">start</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动画链</span></span><br><span class="line"><span class="comment">// tween.chain(tween2);</span></span><br><span class="line"><span class="comment">// tween2.chain(tween);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新动画</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">animate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  tween.<span class="title function_">update</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Three-js/" rel="tag">Three.js</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/webGL/" rel="tag">webGL</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-other/Focal私有化"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/c753f6a1fa26/"
    >FocalBoard 私有化部署</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/c753f6a1fa26/" class="article-date">
  <time datetime="2024-08-26T05:17:00.000Z" itemprop="datePublished">2024-08-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%85%B6%E4%BB%96/">其他</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="最后更新"><a href="#最后更新" class="headerlink" title="最后更新"></a>最后更新</h4><p><strong>2024-12-13</strong></p>
<h4 id="官方安装包"><a href="#官方安装包" class="headerlink" title="官方安装包"></a>官方安装包</h4><p>安装 <a target="_blank" rel="noopener" href="https://github.com/mattermost-community/focalboard/releases">官方包</a>, <a target="_blank" rel="noopener" href="https://www.focalboard.com/download/personal-edition/ubuntu/">[官方文档]</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/mattermost/focalboard/releases/download/v0.15.0/focalboard-server-linux-amd64.tar.gz</span><br><span class="line">tar -xvzf focalboard-server-linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> focalboard /opt</span><br></pre></td></tr></table></figure>

<h4 id="安装数据库"><a href="#安装数据库" class="headerlink" title="安装数据库"></a>安装数据库</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt install postgresql postgresql-contrib</span><br></pre></td></tr></table></figure>

<p>以 postgres 用户创建一个新的数据库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> --login --user postgres</span><br><span class="line">psql</span><br><span class="line"></span><br><span class="line">CREATE DATABASE &lt;your-db-user&gt;;</span><br><span class="line">CREATE USER &lt;your-db-user&gt; WITH PASSWORD &lt;<span class="string">&#x27;your-password&#x27;</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看schema列表</span></span><br><span class="line">\dn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户列表</span></span><br><span class="line">\<span class="built_in">du</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看数据库列表</span></span><br><span class="line"></span><br><span class="line">\l+</span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予用于操作数据库的所有权限</span></span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE &lt;your-db&gt; TO &lt;your-db-user&gt;;</span><br><span class="line"></span><br><span class="line">GRANT ALL ON SCHEMA public TO &lt;your-db-user&gt;;</span><br><span class="line"></span><br><span class="line">\c &lt;your-db-user&gt; postgres</span><br><span class="line"><span class="comment"># You are now connected to database &quot;your-db-user&quot; as user &quot;postgres&quot;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 赋予有用操作public schema的权限</span></span><br><span class="line">GRANT ALL ON SCHEMA public TO &lt;your-db-user&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 退出 postgres 用户</span></span><br><span class="line">\q</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<p>配置链接信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vi /opt/focalboard/config.json</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;dbtype&quot;</span>: <span class="string">&quot;postgres&quot;</span>,</span><br><span class="line"><span class="string">&quot;dbconfig&quot;</span>: <span class="string">&quot;postgres://your-db-user:your-db-password@localhost/boards?sslmode=disable&amp;connect_timeout=10&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> vi /lib/systemd/system/focalboard.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Focalboard server</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5s</span><br><span class="line">ExecStart=/opt/focalboard/bin/focalboard-server</span><br><span class="line">WorkingDirectory=/opt/focalboard</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl start focalboard.service</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> focalboard.service</span><br><span class="line"></span><br><span class="line">curl localhost:8000</span><br></pre></td></tr></table></figure>

<h4 id="nginx-配置"><a href="#nginx-配置" class="headerlink" title="nginx 配置"></a>nginx 配置</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">   listen      443;</span><br><span class="line">   listen [::]:443;</span><br><span class="line">   server_name focal.iftrue.me;</span><br><span class="line"></span><br><span class="line">   location ~ /ws/* &#123;</span><br><span class="line">       proxy_set_header Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">       proxy_set_header Connection <span class="string">&quot;upgrade&quot;</span>;</span><br><span class="line">       client_max_body_size 50M;</span><br><span class="line">       proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">       proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">       proxy_set_header X-Frame-Options SAMEORIGIN;</span><br><span class="line">       proxy_buffers 256 16k;</span><br><span class="line">       proxy_buffer_size 16k;</span><br><span class="line">       client_body_timeout 60;</span><br><span class="line">       send_timeout 300;</span><br><span class="line">       lingering_timeout 5;</span><br><span class="line">       proxy_connect_timeout 1d;</span><br><span class="line">       proxy_send_timeout 1d;</span><br><span class="line">       proxy_read_timeout 1d;</span><br><span class="line">       proxy_pass http://192.168.48.148:8000;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   location / &#123;</span><br><span class="line">       client_max_body_size 50M;</span><br><span class="line">       proxy_set_header Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">       proxy_set_header Host <span class="variable">$http_host</span>;</span><br><span class="line">       proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">       proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">       proxy_set_header X-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line">       proxy_set_header X-Frame-Options SAMEORIGIN;</span><br><span class="line">       proxy_buffers 256 16k;</span><br><span class="line">       proxy_buffer_size 16k;</span><br><span class="line">       proxy_read_timeout 600s;</span><br><span class="line">       proxy_cache_revalidate on;</span><br><span class="line">       proxy_cache_min_uses 2;</span><br><span class="line">       proxy_cache_use_stale <span class="built_in">timeout</span>;</span><br><span class="line">       proxy_cache_lock on;</span><br><span class="line">       proxy_http_version 1.1;</span><br><span class="line">       proxy_pass http://192.168.48.148:8000;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h4><ul>
<li><p>error [2025-03-17 04:28:23.400 Z] Table creation &#x2F; migration failed caller&#x3D;”sqlstore&#x2F;sqlstore.go:75” error&#x3D;”pq: permission denied for schema public”</p>
<p>参照数据库配置步骤，需要赋予用户操作 public schema 的权限</p>
</li>
</ul>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/focalBoard/" rel="tag">focalBoard</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="posts-devops/git命令-配置"
  class="article article-type-posts"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/posts/38d05d58ca17/"
    >Git 命令/配置</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/posts/38d05d58ca17/" class="article-date">
  <time datetime="2024-08-26T00:51:21.000Z" itemprop="datePublished">2024-08-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/DevOps/">DevOps</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h4 id="查看-git-详细命令描述"><a href="#查看-git-详细命令描述" class="headerlink" title="查看 git 详细命令描述"></a>查看 git 详细命令描述</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 会在浏览器打开本地离线文档</span></span><br><span class="line">git <span class="built_in">help</span> [option]</span><br></pre></td></tr></table></figure>

<h4 id="查看仓库配置文件"><a href="#查看仓库配置文件" class="headerlink" title="查看仓库配置文件"></a>查看仓库配置文件</h4><p>查看本地仓库配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> [项目路径]</span><br><span class="line"><span class="built_in">cat</span> ./git/config</span><br></pre></td></tr></table></figure>

<p>查看全局仓库配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config --global -l</span><br></pre></td></tr></table></figure>

<h4 id="设置用户名-x2F-邮箱"><a href="#设置用户名-x2F-邮箱" class="headerlink" title="设置用户名&#x2F;邮箱"></a>设置用户名&#x2F;邮箱</h4><p>用户信息会体现在 commit 提交信息中</p>
<p>设置本地用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config user.name <span class="string">&quot;xxx&quot;</span></span><br><span class="line">git config user.email <span class="string">&quot;xxx@.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>设置全局用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name <span class="string">&quot;xxx&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;xxx@.com&quot;</span></span><br></pre></td></tr></table></figure>

<p>如果本地用户没有设置会优先使用全局的用户设置, 如果存在多个用户可以设置本地用户信息</p>
<h4 id="git-add-做了什么"><a href="#git-add-做了什么" class="headerlink" title="git add 做了什么"></a>git add 做了什么</h4><p>执行 <code>git add .</code> 会将工作区的文件加入到暂存区，体现在 git objects 中会增加一个 <code>.git/objects/[文件sh1前2位]/[文件sh1第3位到40位]]</code> 的文件。<code>[sha1]</code> 的计算逻辑是：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">h = sha1()</span><br><span class="line">h.update(&quot;blob [文件长度]\0&quot;)</span><br><span class="line">h.update(&#x27;[文件内容]&#x27;)</span><br></pre></td></tr></table></figure>

<p>可以使用 cat-file 命令查看文件的 类型和内容，<strong>可以看见用户文件的类型的 blob,这是第一种 object 类型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -t [sha1]  <span class="comment">#查看类型</span></span><br><span class="line">git cat-file -p [sha1]  <span class="comment">#查看内容</span></span><br><span class="line">git cat-file -s [sha1]  <span class="comment">#查看文件长度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看当前目录有所文件的信息</span></span><br><span class="line">git ls-files -s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 100644 e69de29bb2d1d6434b8b29ae775ad8c2e48c5391 0       a/aa.js</span></span><br><span class="line"><span class="comment"># 文件权限         对象名称                                文件名称</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解析 objects 文件的原始内容</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&quot;zlib&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建解压流</span></span><br><span class="line"><span class="keyword">const</span> inflate = zlib.<span class="title function_">createInflate</span>();</span><br><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(</span><br><span class="line">  <span class="string">&quot;./c6dd0164fe0eb4fde767f9e731a6c8ade0b69f&quot;</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&quot;bbb.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理数据流</span></span><br><span class="line">readStream.<span class="title function_">pipe</span>(inflate).<span class="title function_">pipe</span>(writeStream);</span><br></pre></td></tr></table></figure>

<h4 id="git-commit-做了什么"><a href="#git-commit-做了什么" class="headerlink" title="git commit 做了什么"></a>git commit 做了什么</h4><p>查看执行 commit 之后新增文件的类型为 commit，<strong>commit 信息通过 object 文件保存，这是第二种 object 类型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -t [sha1] <span class="comment">#commit</span></span><br></pre></td></tr></table></figure>

<p>查看 commit 后生成文件的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p [sha1]</span><br><span class="line"></span><br><span class="line"><span class="comment">#tree de9ca8d60d61e2dbff58571e243256f0d084e030            tree对象文件名字（sha1）</span></span><br><span class="line"><span class="comment">#parent ef911d46ddddb69cfb0149bbc7217f582c668f21          上一次提交的文件名字(sha1)</span></span><br><span class="line"><span class="comment">#author sunzhiqi &lt;sunzhiqi@live.com&gt; 1724649175 +0800     作者 邮箱  时间戳 时区</span></span><br><span class="line"><span class="comment">#committer sunzhiqi &lt;sunzhiqi@live.com&gt; 1724649175 +0800</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2                                                        提交的文件内容</span></span><br></pre></td></tr></table></figure>

<p>继续查看 tree 文件的内容, <strong>tree 类型描述提交的文件结构，这是第三个 object 类型</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p [sha1]</span><br><span class="line"></span><br><span class="line"><span class="comment">#100644 blob b44836b41abbfc0640d4dd88fe587a9a145e5203    LICENSE</span></span><br><span class="line"><span class="comment">#100644 blob b9c2b056b82135218b26420e8479c56554b54afb    README.md</span></span><br><span class="line"><span class="comment">#100644 blob 4b9a8a29f6956ea1742e42354c5ba36fe717a2ed    a.txt</span></span><br><span class="line"><span class="comment">#100644 blob 9f478040b9109d4b1d25ad7f11528ed9a682f063    b.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果提交内容中有文件夹，那么会有一个单独的 tree 描述文件夹的信息</span></span><br><span class="line"><span class="comment">#100644 tree xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx   folder</span></span><br></pre></td></tr></table></figure>

<p>另外 commit 操作会影响 HEAD 指针的指向</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看HEAD指向的分支</span></span><br><span class="line"><span class="built_in">cat</span> .git/HEAD         <span class="comment">#ref: refs/heads/master</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看分支对应的文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> .git/refs/heads/master         <span class="comment">#ref: f45e2d0b45ca63806d263ae31276a3fbe4a7229d</span></span><br></pre></td></tr></table></figure>

<p><strong>Git 通过 3 种类型的 object files 组织文件</strong></p>
<ul>
<li><p>commit 类型，记录了提交的快照信息<br>提供 parent 指向了上一个提交 hash<br>提供 tree 指向了本次提交的快照</p>
</li>
<li><p>tree 类型，记录了目录结构<br>每次提交都会生成一个新的 tree 文件<br>tree 文件记录了目录下的文件信息，可能是 blob 文件，也可能是另一个 tree</p>
</li>
<li><p>blob 类型，记录了文件内容<br>blob 文件可以在不同的 tree 之间被复用</p>
</li>
</ul>
<h4 id="文件状态流转"><a href="#文件状态流转" class="headerlink" title="文件状态流转"></a>文件状态流转</h4><ul>
<li><p>Untracked 未跟踪, 未被提交到暂存区<br>使用 git add . 将文件加入到暂存区</p>
</li>
<li><p>Modified 已修改，提交暂存区的文件在工作区被修改了<br>用 git add . 将文件提交修改到暂存区</p>
</li>
<li><p>Staged 已暂存，提交到暂存区的文件<br>git commit 将暂存区的文件提交到仓库区</p>
</li>
<li><p>Unmodified 代码仓库中的状态</p>
</li>
</ul>
<h4 id="diff-查看文件差异"><a href="#diff-查看文件差异" class="headerlink" title="diff 查看文件差异"></a>diff 查看文件差异</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对比工作区和暂存区</span></span><br><span class="line">git diff</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比暂存区和仓库区</span></span><br><span class="line">git diff --cached</span><br></pre></td></tr></table></figure>

<h4 id="branch-operations"><a href="#branch-operations" class="headerlink" title="branch operations"></a>branch operations</h4><p>分支的本质是指向 commit 的指针, 使用自定义名称代指 commit hash</p>
<p>git checkout 可以用于切换分支，也可以用于切换到某个 commit， 当使用这个命令后会提示正在处于一个分离头指针的状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout [<span class="built_in">hash</span>]</span><br></pre></td></tr></table></figure>

<p>如果相对当前 commit 修改需要依附于一个分支,可以使用 git switch -c [branchName], 在旧的版本中可以使用 git checkout -b [branchName]</p>
<h5 id="fast-forward"><a href="#fast-forward" class="headerlink" title="fast-forward"></a>fast-forward</h5><p>从 master 切换到 feature 分支，如果 master commit 没有变化, 那么可以直接将 master 的指针指向 feature</p>
<p>如果分支已经合并，可以使用 <code>git reset ORIG_HEAD</code> 回到 merge 之前的 commit</p>
<p>commit 回滚后修改的文件会在本地显示为 untracked 或 modified 也就是在 feature 分支中修改或新增的文件。</p>
<p>如果需要丢弃这些修改可是使用 <code>git restore [filename]</code> 或 <code>git restore .</code> 丢弃所有修改。</p>
<p>如果有添加在暂存区的文件，可以使用 <code>git restore --staged .</code> 丢弃暂存区的修改</p>
<h5 id="3-way-merge"><a href="#3-way-merge" class="headerlink" title="3 way merge"></a>3 way merge</h5><p>如果 feature 分支落后于 master 分支，也就是在 feature 分支上提交了 commit 的同时， master 分支也提交了 commit， 那么在合并的时候会产生一个新的 commit 记录这两个分支的合并。查看这次新分支的提交内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p 4ba28b350b0a8f0b</span><br><span class="line"></span><br><span class="line">tree 444ca23d83cc70878ddb01e5288a4322ded5ac0c</span><br><span class="line">parent 57086086b9bd92402227d58e7c6b87e285376910</span><br><span class="line">parent 720f3a44023361a4bad5586fe769ccc50f1bc1ab</span><br><span class="line">author sunzhiqi &lt;sunzhiqi@live.com&gt; 1744018132 +0800</span><br><span class="line">committer sunzhiqi &lt;sunzhiqi@live.com&gt; 1744018132 +0800</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到有两个 parent 指向，分别是 feature 最新的 commit hash 和 master 分支的合并之前的 commit hash。</p>
<h5 id="conflict-3-way-merge"><a href="#conflict-3-way-merge" class="headerlink" title="conflict 3 way merge"></a>conflict 3 way merge</h5><p>如果两个分支都修改了同一个文件，那么在合并的时候会产生冲突。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;&lt;&lt;&lt; <span class="string">HEAD</span></span><br><span class="line"><span class="string">master 的内容</span></span><br><span class="line"><span class="string">=======</span></span><br><span class="line"><span class="string">feature 的内容</span></span><br><span class="line"><span class="string">&gt;&gt;&gt;&gt;&gt;&gt; feature</span></span><br></pre></td></tr></table></figure>

<p>手动解决冲突后使用 <code>git add .</code> 提交暂存区, 然后执行 <code>git commit</code> 完成合并操作</p>
<h5 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h5><p>rebase 会将当前分支落后的于 master 分支的 commit 整合到当前分支，这样当前分支包含了 master 分支的最新 commit， 所以再次在 master 分支上执行 merge 操作就可以实现 fast-forward 合并。</p>
<p><strong>rebase 操作通常避免在 master 分支上执行，并且会修改已经提交的 commit hash,这可能会导致于已经提交到远程的 commit 冲突，多人协作中应该禁止。</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout feature</span><br><span class="line">git rebase master</span><br><span class="line">git checkout master</span><br><span class="line">git merge feature</span><br></pre></td></tr></table></figure>

<h4 id="remote-branch"><a href="#remote-branch" class="headerlink" title="remote branch"></a>remote branch</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git branch -r  <span class="comment"># 查看远程分支</span></span><br><span class="line">git branch -a  <span class="comment"># 查看本地和远程分支</span></span><br><span class="line"></span><br><span class="line">git remote add origin [url] <span class="comment"># 关联远程仓库</span></span><br><span class="line">git remote -vv  <span class="comment"># 查看远程仓库</span></span><br><span class="line">git remote show origin <span class="comment"># 查看远程仓库详情</span></span><br></pre></td></tr></table></figure>

<h5 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h5><p>fetch 操作会将远程分支的最新 commit 信息下载到本地，但是不会自动合并到当前分支，也就是不会移动 HEAD 指针。</p>
<p>如果远程分支删除，需要本地同步可以使用以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git fetch --prune</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者</span></span><br><span class="line">git remote prune</span><br></pre></td></tr></table></figure>

<p>fetch 操作会使用一个非常重要的文件，**.git&#x2F;FETCH_HEAD**, 它记录所有远程分支的最新 commit 信息。<strong>并且当 git fetch 执行的时候会将当前分支信息置于文件顶部，其余的分支信息排在后面，这样 git pull 命令会利用最前面的分支信息合并分支</strong></p>
<h5 id="pull"><a href="#pull" class="headerlink" title="pull"></a>pull</h5><p><code>git pull</code> 操作会修改&#x2F;创建 ORIG_HEAD 指针，并且移动 HEAD 指向 merge 之前的 commit 可以用于回滚操作。</p>
<h5 id="push"><a href="#push" class="headerlink" title="push"></a>push</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git push origin master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除远程分支</span></span><br><span class="line">git push origin --delete feature</span><br><span class="line">git push origin -d feature</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送本地标签到远程</span></span><br><span class="line">git push origin --tags</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关联远程分支</span></span><br><span class="line">git branch --set-upstream-to=origin/feature feature</span><br><span class="line"></span><br><span class="line">git branch --set-upstream origin feature</span><br><span class="line">git branch -u origin feature</span><br></pre></td></tr></table></figure>

<h5 id="cherry-pick"><a href="#cherry-pick" class="headerlink" title="cherry-pick"></a>cherry-pick</h5><p>当分支无法合并,需要把某个分支的 commit 合并到另一个分支，可以使用 cherry-pick。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 切换到目标分支</span></span><br><span class="line">git cherry-pick [commitID]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 合并多个 commit</span></span><br><span class="line">git cherry-pick [commitID1] [commitID2]</span><br></pre></td></tr></table></figure>

<h4 id="tag"><a href="#tag" class="headerlink" title="tag"></a>tag</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git tag v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建带注释的标签 -a 表示创建带注释的标签</span></span><br><span class="line">git tag -a v1.0 -m <span class="string">&#x27;tag message&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定任意commit打标签</span></span><br><span class="line">git tag -a v1.0 [commitID]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看标签</span></span><br><span class="line">git tag</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看标签详情</span></span><br><span class="line">git show v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除标签</span></span><br><span class="line">git tag -d v1.0</span><br></pre></td></tr></table></figure>

<p><code>git tag v1.0</code> 创建轻量标签存放在 <code>.git/refs/tags</code> 目录下</p>
<p><code>git tag -a v1.0 -m &#39;tag message</code> 除了保存在 <code>.git/refs/tags</code> 目录下，还会创建一个对象文件保存在 <code>.git/objects</code> 下，<strong>类型是 tag, 这是第四种类型的 object，同时保存信息还包括注释，时间，作者</strong></p>
<h4 id="submodule"><a href="#submodule" class="headerlink" title="submodule"></a>submodule</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加子模块</span></span><br><span class="line">git submodule add [url]</span><br><span class="line">git submodule add ./path/to/submodule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 首次 clone 项目不会包含子模块的内容</span></span><br><span class="line"><span class="comment"># 进入到子模块目录 执行</span></span><br><span class="line">git submodule update --init --recursive</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次更新子模块</span></span><br><span class="line">git submodule update --remote</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除子模块</span></span><br><span class="line">git <span class="built_in">rm</span> submodule</span><br><span class="line"><span class="built_in">rm</span> -rf .git/modules/submodule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 .gitmodules 中移除该 submodule</span></span><br><span class="line">vim .gitmodules</span><br><span class="line"></span><br><span class="line"><span class="comment"># 从 .git/config 中移除该 submodule</span></span><br><span class="line">vim .git/config</span><br></pre></td></tr></table></figure>

<h4 id="我提交了什么"><a href="#我提交了什么" class="headerlink" title="我提交了什么"></a>我提交了什么</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git show</span><br><span class="line">git <span class="built_in">log</span> -n1 -p</span><br></pre></td></tr></table></figure>

<h4 id="想修改最近的提交信息"><a href="#想修改最近的提交信息" class="headerlink" title="想修改最近的提交信息"></a>想修改最近的提交信息</h4><p>提交信息后(commit),发现信息写错了，想修改最近一条提交信息(如果想修改当前提交以前的信息)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend --only [filename] -m <span class="string">&#x27;update&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会弹出交互式命令行手动提交</span></span><br><span class="line">git commit --amend --only [filename]</span><br></pre></td></tr></table></figure>

<p><code>--only</code> 参数非常重要,只对当前正在修改的文件进行提交，而不包括暂存区中的其他文件。</p>
<h4 id="怎么看是否落后与主分支"><a href="#怎么看是否落后与主分支" class="headerlink" title="怎么看是否落后与主分支"></a>怎么看是否落后与主分支</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git fetch origin</span><br><span class="line">git status</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># oneline  提交显示为一行</span></span><br><span class="line"><span class="comment"># graph    左侧显示一个 ASCII 图形，用于展示分支和合并的关系</span></span><br><span class="line"><span class="comment"># decorate 提交信息中附加上相关的分支、标签等引用名称</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看远程分支所有提交历史</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --graph --decorate origin/master</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看所有分支的提价历史</span></span><br><span class="line">git <span class="built_in">log</span> --graph --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定分支</span></span><br><span class="line"></span><br><span class="line">git <span class="built_in">log</span> --graph origin/master master</span><br></pre></td></tr></table></figure>

<p>从分支上可以看出，主分支并没有 fff 的提交，最终合并在本地的 master 分支</p>
<h4 id="取消上次提交中的某个文件"><a href="#取消上次提交中的某个文件" class="headerlink" title="取消上次提交中的某个文件"></a>取消上次提交中的某个文件</h4><p>一次提交中包括， <code>a.txt</code>, <code>b.txt</code> 现在想取消 <code>a.txt</code> 的提交，也就是恢复为上一次的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看上一次提交文件的内容</span></span><br><span class="line">git show [commitID]:a.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将工作区中的文件恢复为上一次提交的内容</span></span><br><span class="line">git checkout HEAD^ a.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用 commitId</span></span><br><span class="line">git checkout [commitId] a.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将恢复的文件加入暂存区   -A 参数可以将删除文件也从暂存区删除</span></span><br><span class="line">git add .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 提交修改到暂存区，沿用上一次的ID，并且不修改提交描述</span></span><br><span class="line">git commit --amend --no-edit</span><br></pre></td></tr></table></figure>

<p>如果当前的的历史已经提交到远程，由于并没有改变提交历史，所以可以安全的 <code>git push -f</code></p>
<h4 id="删除-上一次-x2F-多个-Commit"><a href="#删除-上一次-x2F-多个-Commit" class="headerlink" title="删除 上一次&#x2F;多个 Commit"></a>删除 上一次&#x2F;多个 Commit</h4><p>极不建议使用，虽然可以用 reset 重置为上一级的状态，但是会丢失当前的修改，而且会破坏提交历史。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HEAD^ 上一个提交状态</span></span><br><span class="line"><span class="comment"># hard 改变暂存区和工作目录到指定的提交</span></span><br><span class="line">git reset HEAD^ --hard</span><br></pre></td></tr></table></figure>

<p>使用 soft 参数可以避免工作区被回滚，但提交历史已经被改变，如果你的分支还会被其他人使用，多人写作中会有安全问题。避免在公共分支中使用 <code>git reset</code>,</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset HEAD^ --soft</span><br></pre></td></tr></table></figure>

<p>对于公共分支唯一安全的做法是使用 <code>revert</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git revert [commitId]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果有冲突，解决冲突后执行</span></span><br><span class="line">git add .</span><br><span class="line">git revert --<span class="built_in">continue</span></span><br></pre></td></tr></table></figure>

<h4 id="修改-commit-之后不能-push"><a href="#修改-commit-之后不能-push" class="headerlink" title="修改 commit 之后不能 push"></a>修改 commit 之后不能 push</h4><ul>
<li>可能你已经将历史 push 到远程，但是又修改了本地的最近的 commit, 导致 git 理解为你的 commit 和 远程的不同需要先合并分支。<br><strong>尽可能避免修改一个已经推送到远程的历史</strong>，如果必须要这样做，只能使用 <code>git push -f</code></li>
</ul>
<h4 id="reset-之后想找回"><a href="#reset-之后想找回" class="headerlink" title="reset 之后想找回"></a>reset 之后想找回</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用reflog查看头指针的移动历史</span></span><br><span class="line">git reflog</span><br><span class="line">git reset --hard [commitId]</span><br></pre></td></tr></table></figure>

<h4 id="提交文件的一部分-x2F-分别提交到两个-commit"><a href="#提交文件的一部分-x2F-分别提交到两个-commit" class="headerlink" title="提交文件的一部分&#x2F;分别提交到两个 commit"></a>提交文件的一部分&#x2F;分别提交到两个 commit</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用交互式命令行操作</span></span><br><span class="line">git add -p [filename]</span><br><span class="line"></span><br><span class="line"><span class="comment">#y - 将该 hunk 添加到暂存区</span></span><br><span class="line"><span class="comment">#n - 不将该 hunk 添加到暂存区</span></span><br><span class="line"><span class="comment">#s - 拆分当前 hunk 成更小的块</span></span><br><span class="line"><span class="comment">#e - 手动编辑当前 hunk</span></span><br><span class="line"><span class="comment">#q - 退出暂存模式</span></span><br><span class="line"><span class="comment">#a - 将当前文件的所有剩余 hunk 添加到暂存区</span></span><br><span class="line"><span class="comment">#d - 不将当前文件的任何剩余 hunk 添加到暂存区</span></span><br></pre></td></tr></table></figure>

<p>使用 <code>e</code> 手动编辑的模式时：</p>
<ul>
<li>如果想要取消删除行的修改，需要将行前的 <code>-</code> 替换为 <code> </code> 空字符</li>
<li>如果想要取消新增行的修改， 需要将 <code>+</code> 行整体删除</li>
</ul>
<p>添加到暂存区中后执行 <code>commit</code> 操作，接着再次执行一次 <code>git add .</code> 提交剩余的修改。</p>
<h4 id="有临时工作又不想提交当前的修改"><a href="#有临时工作又不想提交当前的修改" class="headerlink" title="有临时工作又不想提交当前的修改"></a>有临时工作又不想提交当前的修改</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 stash 命令暂存当前修改</span></span><br><span class="line">git stash</span><br><span class="line">git stash push -m <span class="string">&quot;描述&quot;</span> <span class="comment">#为stash添加描述</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 切换到需要工作的分支进行开发</span></span><br><span class="line">git checkout [branch]</span><br><span class="line"><span class="comment"># 在当前分支中想要合并最新的主分支，也可以使用暂存功能</span></span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># 工作结束后切换回原来的分支，并从暂存中取出内容</span></span><br><span class="line">git checkout [main branch]</span><br><span class="line">git stash pop</span><br></pre></td></tr></table></figure>

<h4 id="仅-stash-未暂存的更改，而保留暂存区的内容"><a href="#仅-stash-未暂存的更改，而保留暂存区的内容" class="headerlink" title="仅 stash 未暂存的更改，而保留暂存区的内容"></a>仅 stash 未暂存的更改，而保留暂存区的内容</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 已经git add 的内容不想放到stash中</span></span><br><span class="line"><span class="comment"># 只把刚在工作区修改的内容放到stash中</span></span><br><span class="line">git stash --keep-index</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果有文件还没有git add添加过，想要stash这些文件</span></span><br><span class="line">git stash -u</span><br></pre></td></tr></table></figure>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/DevOps/" rel="tag">DevOps</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/29/">29</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2015-2025
        <i class="ri-heart-fill heart_icon"></i> SunZhiqi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.png" alt="四月八日"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>此时无声胜有声！</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="/js/jquery.modal.min.js"></script>
<link rel="stylesheet" href="/css/jquery.modal.min.css" />
<script src="/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
  <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
  <div class="pswp__bg"></div>

  <!-- Slides wrapper with overflow:hidden. -->
  <div class="pswp__scroll-wrap">
    <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>

    <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
    <div class="pswp__ui pswp__ui--hidden">
      <div class="pswp__top-bar">
        <!--  Controls are self-explanatory. Order can be changed. -->

        <div class="pswp__counter"></div>

        <button
          class="pswp__button pswp__button--close"
          title="Close (Esc)"
        ></button>

        <button
          class="pswp__button pswp__button--share"
          style="display: none"
          title="Share"
        ></button>

        <button
          class="pswp__button pswp__button--fs"
          title="Toggle fullscreen"
        ></button>

        <button
          class="pswp__button pswp__button--zoom"
          title="Zoom in/out"
        ></button>

        <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
        <!-- element will get class pswp__preloader--active when preloader is running -->
        <div class="pswp__preloader">
          <div class="pswp__preloader__icn">
            <div class="pswp__preloader__cut">
              <div class="pswp__preloader__donut"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
        <div class="pswp__share-tooltip"></div>
      </div>

      <button
        class="pswp__button pswp__button--arrow--left"
        title="Previous (arrow left)"
      ></button>

      <button
        class="pswp__button pswp__button--arrow--right"
        title="Next (arrow right)"
      ></button>

      <div class="pswp__caption">
        <div class="pswp__caption__center"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="/css/photoswipe.min.css" />
<link rel="stylesheet" href="/css/default-skin.min.css" />
<script src="/js/photoswipe.min.js"></script>
<script src="/js/photoswipe-ui-default.min.js"></script>

<script>
  function viewer_init() {
    let pswpElement = document.querySelectorAll(".pswp")[0];
    let $imgArr = document.querySelectorAll(
      ".article-entry img:not(.reward-img)"
    );

    $imgArr.forEach(($em, i) => {
      $em.onclick = () => {
        // slider展开状态
        // todo: 这样不好，后面改成状态
        if (document.querySelector(".left-col.show")) return;
        let items = [];
        $imgArr.forEach(($em2, i2) => {
          let img = $em2.getAttribute("data-idx", i2);
          let src =
            $em2.getAttribute("data-target") || $em2.getAttribute("src");
          let title = $em2.getAttribute("alt");
          // 获得原图尺寸
          const image = new Image();
          image.src = src;
          items.push({
            src: src,
            w: image.width || $em2.width,
            h: image.height || $em2.height,
            title: title,
          });
        });
        var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
          index: parseInt(i),
        });
        gallery.init();
      };
    });
  }
  viewer_init();
</script>
 
<!-- MathJax -->
 <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="/js/MathJax.js"></script>
<script src="/js/TeX-AMS-MML_HTMLorMML-full.js"></script>

<script>
  var ayerConfig = {
    mathjax: true,
  };
</script>

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->

<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="/js/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !(function (e, t, a) {
    var initCopyCode = function () {
      var copyHtml = "";
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += "</button>";
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS(".btn-copy", {
        target: function (trigger) {
          return trigger.nextElementSibling;
        },
      });
      clipboard.on("success", function (e) {
        let $btn = $(e.trigger);
        $btn.addClass("copied");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-checkbox-circle-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPIED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-checkbox-circle-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
      clipboard.on("error", function (e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass("copy-failed");
        let $icon = $($btn.find("i"));
        $icon.removeClass("ri-file-copy-2-line");
        $icon.addClass("ri-time-line");
        let $span = $($btn.find("span"));
        $span[0].innerText = "COPY FAILED";

        wait(function () {
          // 等待两秒钟后恢复
          $icon.removeClass("ri-time-line");
          $icon.addClass("ri-file-copy-2-line");
          $span[0].innerText = "COPY";
        }, 2000);
      });
    };
    initCopyCode();
  })(window, document);
</script>
 
<!-- CanvasBackground -->

<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "default" });
  }
</script>


    
    

  </div>
</body>

</html>